<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>catencfamily &mdash; Documentation of package catencfamily 0.0.96 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=2f74cb28"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Documentation of package catencfamily
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">CatEncFamily Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html#module-utils">Utils Module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Documentation of package catencfamily</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">catencfamily</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for catencfamily</h1><div class="highlight"><pre>
<span></span><span class="c1"># 24th Dec, 2023</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">References:</span>
<span class="sd">Coding standard:</span>
<span class="sd">    https://gist.github.com/nateGeorge/5455d2c57fb33c1ae04706f2dc4fee01</span>
<span class="sd">    </span>
<span class="sd">Developing sklearn estimators:</span>
<span class="sd">    https://scikit-learn.org/stable/developers/develop.html </span>
<span class="sd">    </span>
<span class="sd">Project template:</span>
<span class="sd">    https://github.com/scikit-learn-contrib/project-template/    </span>
<span class="sd">    </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># 1.0 Libraries</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="c1"># 1.01 For networks and centrality measures</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">networkx.algorithms</span> <span class="kn">import</span> <span class="n">bipartite</span>
<span class="kn">from</span> <span class="nn">cdlib</span> <span class="kn">import</span> <span class="n">algorithms</span><span class="p">,</span> <span class="n">evaluation</span>


<span class="c1"># 1.02</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">normalize</span>

<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>

<span class="c1"># 1.03 Misc</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span>  <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span><span class="nn">gc</span><span class="o">,</span> <span class="nn">pickle</span>




<div class="viewcode-block" id="CatEncodersFamily"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily">[docs]</a><span class="k">class</span> <span class="nc">CatEncodersFamily</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class to encode categorical features in multiple but related </span>
<span class="sd">    ways using network analysis. Together, the family of multiple encodings</span>
<span class="sd">    serve as a numerical vector for every level of a categorical feature.</span>
<span class="sd"> </span>
<span class="sd">    The class transforms a group of categorical features into corresponding</span>
<span class="sd">    numerical features which can then be used either in unsupervised learning </span>
<span class="sd">    or predictive analytics. To assist in unsupervised learning, the class</span>
<span class="sd">    has methods to save a categorical feature as network graphs and plot them.</span>
<span class="sd">    </span>
<span class="sd">    The class has methods to extract unit vectors (numerical) for every </span>
<span class="sd">    level of a categorical feature to help, for example, in understanding</span>
<span class="sd">    relationshsips between various levels. Extracted numerical vectors</span>
<span class="sd">    can directly be used in plotting for example in tensorflow&#39;s Embedding </span>
<span class="sd">    Projector.</span>
<span class="sd">    </span>
<span class="sd">    As the encodings are calculated using a group of network analysis operations,</span>
<span class="sd">    the family of encodings is extensible. The class provides one way, but a </span>
<span class="sd">    limited one to extend it.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    
    
<div class="viewcode-block" id="CatEncodersFamily.__init__"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">pathToStoreProgress</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">modelsPath</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">mapDictPath</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cMeasures</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>  <span class="n">noOfColsToConcat</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> 
                 <span class="n">k</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_iter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sampsize</span><span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">avg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">saveGraph</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
                 <span class="n">mergelevelsincols</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">mergethreshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">replaceby</span> <span class="o">=</span> <span class="s1">&#39;99999&#39;</span><span class="p">,</span>
                 <span class="n">avoidInteractionFeatures</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">multigraph</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pathToStoreProgress :string; As dictionaries are created </span>
<span class="sd">                             to map cat-column levels to different </span>
<span class="sd">                             centrality measures, a file records the progress.</span>
<span class="sd">                             The progress file is placed in this folder. </span>
<span class="sd">                             Default folder is &lt;currentfolder&gt;/allmodels/progress/ </span>
<span class="sd">        modelsPath : string; When, n_iter &gt;1, dictionaries created to map cat-column</span>
<span class="sd">                     levels to difft centrality measures, per iteration, are saved </span>
<span class="sd">                     here in .pkl file. Before saving, dictionaries are transformed</span>
<span class="sd">                     to pandas DataFrame and then saved. Such DataFrames are, at times,</span>
<span class="sd">                     being called as models in this help. Default modelsPath folder is </span>
<span class="sd">                     &lt;currentfolder&gt;/allmodels/models/ </span>
<span class="sd">        cMeasures : list; It specifies what all centrality measures are to be calculated.</span>
<span class="sd">                    One can also specify a function object that calculates some centrality</span>
<span class="sd">                    measure. The default cMeasures is [1,1,1,0,None,1,1].</span>
<span class="sd">                    </span>
<span class="sd">                    Presence of 1 or 0 in cMeasures implies:</span>
<span class="sd">                    Ist   1            calculate degree centrality</span>
<span class="sd">                    IInd  1            calculate eigenvector centrality</span>
<span class="sd">                    IIIrd 1            calculate pagerank centrality,</span>
<span class="sd">                    IVth  1            calculate clustering coefficient,</span>
<span class="sd">                    Vth  func_obj      for user specified function object</span>
<span class="sd">                                       to calculate centrality. It requires</span>
<span class="sd">                                       that IV element be also 1. If IV elem</span>
<span class="sd">                                       is 0, then func_obj will not be </span>
<span class="sd">                                       evaluated.</span>
<span class="sd">                    VI    1            calculate betweenness centrality</span>
<span class="sd">                    VII   1            is for discovering communities (Which node</span>
<span class="sd">                                       belongs to which community? ) and community</span>
<span class="sd">                                       characteristics: density and avg_embeddedness.</span>
<span class="sd">                                       </span>
<span class="sd">                           0           at any pos means not to calculate that </span>
<span class="sd">                                       specific measure</span>
<span class="sd">                    </span>
<span class="sd">        noOfColsToConcat : int; Before centrality measures are calculated, new columns</span>
<span class="sd">                           are created by taking as many cat columns at a time as noOfColsToConcat</span>
<span class="sd">                           Presently only a value of 2 is allowed. That is, if there are 3 cat cols</span>
<span class="sd">                           [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;] new concatenated cols will be: [&#39;a+b&#39;, &#39;a+c&#39;, &#39;b+c&#39;]</span>

<span class="sd">        k : int; If k is not None use k node samples to estimate betweenness.</span>
<span class="sd">           The value of k &lt;= n where n is the number of nodes in the graph.</span>
<span class="sd">           Higher values give better approximation. Only relevant if betweenness centrality</span>
<span class="sd">           is to be calculated.</span>
<span class="sd">           </span>
<span class="sd">        n_iter : int; The number of times cMeasures are to be calculated over different samples of data,</span>
<span class="sd">                 Default is 1 when cMeasures is calculated over complete data.</span>
<span class="sd">                 </span>
<span class="sd">        sampsize : float; Sample size of data over which cMeasures to be calculated when n_iter &gt; 1.</span>
<span class="sd">                   The default is 0.8.</span>
<span class="sd">                   </span>
<span class="sd">        avg : boolean; When n_iter &gt; 1, each one of cMeasures is calcuated n_iter times. To calculate</span>
<span class="sd">              a final value either average or median of each cMeasures is taken.</span>
<span class="sd">              If avg is True (the default) then for each cMeasures (say, pagerank Centrality)</span>
<span class="sd">              avg over all n_iter is taken; if False, median is computed.</span>
<span class="sd">              </span>
<span class="sd">        saveGraph : boolean; Should network-graph files be saved to disk or not. </span>
<span class="sd">                    The default is False.</span>
<span class="sd">                    </span>
<span class="sd">        cutoff: int; If number of levels in any one of the cat columns (or concatenated cat</span>
<span class="sd">                cols) are below cutoff, ignore that cat col. (see _cleanup())</span>
<span class="sd">                    </span>
<span class="sd">        verbose : int; Intensity of msgs to be displayed. Presently, this parameter may not </span>
<span class="sd">                  display much control over display of msg(s). The default is 3.</span>
<span class="sd">        </span>
<span class="sd">        random_state: int; Controls the shuffling applied to the data before applying the </span>
<span class="sd">                      train_test_split. Pass an int for reproducible output across multiple </span>
<span class="sd">                      function calls.</span>
<span class="sd">                      </span>
<span class="sd">        mapDictPath: string; Name of folder where dictionaries are kept that map existing levels</span>
<span class="sd">                     to &#39;replaceby&#39; values.                </span>
<span class="sd">                      </span>
<span class="sd">        mergelevelsincols: list of str; List of columns whose levels need to be merged through multiple</span>
<span class="sd">                           iterations. Certain large datasets have few cols with very large </span>
<span class="sd">                           number of levels. This is a list of such columns. Presently only one</span>
<span class="sd">                           column is supported.</span>
<span class="sd">        mergethreshold: list of floats : Merge threshold levels for each column, listed in </span>
<span class="sd">                                         mergelevelsincols    </span>
<span class="sd">        replaceby: String integer; Name of new level when multiple levels are merged. Default</span>
<span class="sd">                   &#39;99999&#39;</span>
<span class="sd">                   </span>
<span class="sd">        avoidInteractionFeatures: List; For col names listed here, avoid combination with </span>
<span class="sd">                                  created interaction features  </span>
<span class="sd">        multigraph: Bipartite to unipartite projection yields simple graph or multigraph.</span>
<span class="sd">                    It will yield multigraph when multigraph = True                          </span>
<span class="sd">                  </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span> <span class="o">=</span> <span class="n">cMeasures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noOfColsToConcat</span> <span class="o">=</span> <span class="n">noOfColsToConcat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pathToStoreProgress</span> <span class="o">=</span> <span class="n">pathToStoreProgress</span> <span class="c1"># If none, folders are created below currrent folder</span>
        <span class="c1"># When n_iter &gt; 1, model-dictionaries are stored</span>
        <span class="c1"># as DataFrames in .pkl files in this folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modelsPath</span> <span class="o">=</span> <span class="n">modelsPath</span> <span class="c1"># If none, folders are created below currrent folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>    <span class="c1"># No of random sample of nodes to be considered for calculating</span>
                      <span class="c1">#  betweenness centrality;. k &lt;= n;</span>
                      <span class="c1">#  k is considered only if cMeasures[5] is 1.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">=</span> <span class="n">n_iter</span>      <span class="c1"># Number of loops; bootstrap samples are taken</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampsize</span> <span class="o">=</span> <span class="n">sampsize</span> <span class="c1"># Ignored if n_iter = 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Ignored if n_iter = 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveGraph</span> <span class="o">=</span> <span class="n">saveGraph</span>  <span class="c1"># Should graph objects be saved for later plotting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">cutoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>  <span class="c1"># Presently unused</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mergelevelsincols</span> <span class="o">=</span> <span class="n">mergelevelsincols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mergethreshold</span> <span class="o">=</span> <span class="n">mergethreshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapDictPath</span> <span class="o">=</span> <span class="n">mapDictPath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replaceby</span> <span class="o">=</span> <span class="n">replaceby</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avoidInteractionFeatures</span> <span class="o">=</span> <span class="n">avoidInteractionFeatures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multigraph</span> <span class="o">=</span> <span class="n">multigraph</span></div>


    
            
    
<div class="viewcode-block" id="CatEncodersFamily.fit"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">cat_cols</span> <span class="p">,</span> <span class="n">interactingCatCols</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: None</span>
<span class="sd">        Calls: _checkMissing(), _checkParamsIntegrity(), _interactionCols()</span>
<span class="sd">               _permuteColList(), _cleanup(), _getSample(), _getStoreFeatures()</span>
<span class="sd">               </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas DataFrame; X is a dataframe having only cat_cols</span>
<span class="sd">        cat_cols : list; Categorical columns to be considered</span>
<span class="sd">                   Categorical column names MUST ONLY have</span>
<span class="sd">                   a-zA-Z characters; no underscore etc</span>
<span class="sd">        interactingCatCols : list; Cat columns that will interact</span>
<span class="sd">                             to make new columns. Interaction</span>
<span class="sd">                             of two cat columns, x and y would</span>
<span class="sd">                             produce a new cat column x_p_y</span>
<span class="sd">                             with corrresponding levels of both </span>
<span class="sd">                             concatenated row-by-row.</span>
<span class="sd">        y : numpy array or pandas Series. Target feature. </span>
<span class="sd">            Needed to get stratified sample when </span>
<span class="sd">            sampsize &lt; 1. Ignored when n_iter = 1</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Class object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_cols</span> <span class="o">=</span> <span class="n">cat_cols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactingCatCols</span> <span class="o">=</span> <span class="n">interactingCatCols</span>
        
        <span class="c1"># modelList_ would contain dictioaries that map</span>
        <span class="c1"># each cat column&#39;s levels to some network</span>
        <span class="c1"># characteristics or centrality measure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modelList_</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactingCatCols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="kc">False</span>
            
                    
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Pass a pandas.DataFrame&quot;</span><span class="p">)</span>  
            
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_cols</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Pass cat_cols as a list of column names&quot;</span><span class="p">)</span>    


        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interactingCatCols</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Pass interactingCatCols as a list of column names or as an empty list&quot;</span><span class="p">)</span>   
            
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampsize</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;When n_iter &gt; 1,&#39;target&#39; must be passed in fit().&quot;</span><span class="p">)</span> 
                
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pathToStoreProgress</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create two folders: </span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="s1">&#39;allmodels&#39;</span> <span class="o">/</span> <span class="s1">&#39;progress&#39;</span> 
            <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pathToStoreProgress</span> <span class="o">=</span>  <span class="n">path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create specified path if it does not exist</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathToStoreProgress</span><span class="p">)</span>
            <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
       
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelsPath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create folders below current directory</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveGraph</span>  <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span>  <span class="s1">&#39;allmodels&#39;</span> <span class="o">/</span> <span class="s1">&#39;models&#39;</span> 
                <span class="n">p</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">modelsPath</span> <span class="o">=</span> <span class="n">p</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Folder &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelsPath</span><span class="p">,</span> <span class="s2">&quot;created to deposit cat encoder models and graph related files&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create specified path if it does not exist</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modelsPath</span><span class="p">)</span>
            <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            
        <span class="bp">self</span><span class="o">.</span><span class="n">n_features_in_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkParamsIntegrity</span><span class="p">()</span>
        
        <span class="c1"># Pass on copy of X so that original X is unaffected</span>
        <span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_cols_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interactionCols</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        
        <span class="n">cc_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_cols</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>    <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_cols_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">cc_</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_cols_</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">single_permute_list_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permuteColList</span><span class="p">(</span><span class="n">cc_</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">single_permute_list_</span> <span class="o">=</span> <span class="p">[</span>  <span class="n">i</span>   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_permute_list_</span>  <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_cols</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_permute_list_</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">(</span> <span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_permute_list_</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkMissing</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        
        <span class="n">fulllist_</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">final_permute_list_</span><span class="p">]</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathToStoreProgress</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span>  <span class="s2">&quot;networkPerformanceData.csv&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o</span><span class="p">:</span>
                <span class="n">o</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;timeOfWritingToFile,&quot;</span> <span class="o">+</span> <span class="s2">&quot;bipartiteNetCreation_time&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="s2">&quot;bipartiteNetPojection_time&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="s2">&quot;modelExtraction_time,&quot;</span> <span class="o">+</span> <span class="s2">&quot;colToProject,&quot;</span> <span class="o">+</span> <span class="s2">&quot;intermediaryCol&quot;</span><span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                         
                     
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
                <span class="n">X1</span> <span class="o">=</span> <span class="n">X</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># y is needed to get stratified sample </span>
                <span class="c1">#  of size sampsize</span>
                <span class="n">X1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getSample</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fulllist_</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Record set no is </span><span class="si">{}</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Set of records is: &quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                <span class="c1"># Each outer loop creates a new sets of models</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_getStoreFeatures</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">j</span> <span class="p">)</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding_</span> <span class="o">=</span> <span class="kc">True</span>     <span class="c1"># Transformer is fitted</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    


            
        
<div class="viewcode-block" id="CatEncodersFamily._checkParamsIntegrity"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._checkParamsIntegrity">[docs]</a>    <span class="k">def</span> <span class="nf">_checkParamsIntegrity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: fit()</span>
<span class="sd">        Calls: None  </span>
<span class="sd">        </span>
<span class="sd">        Checks if class parameters are correctly specified</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;n_iter can not be 0. Default is 1.&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;cat_cols can not be empty&quot;</span>

        <span class="c1"># Check cat_cols names. These must not contain</span>
        <span class="c1"># any char other than a-zA-Z and _. Else, exception </span>
        <span class="c1"># is raised</span>
        <span class="c1"># https://stackoverflow.com/a/3301453</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_cols</span> <span class="k">if</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column names have spaces </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">. Remove spaces first.&quot;</span><span class="p">)</span>
        
        <span class="n">a</span> <span class="o">=</span> <span class="p">[</span> <span class="n">i</span>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_cols</span> <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">))]</span> 
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column names have digits; </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">. Rename cols to remove digits.&quot;</span><span class="p">)</span>

        <span class="c1"># https://stackoverflow.com/a/336220/3282777</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_cols</span>       <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;^[a-zA-Z_]+$&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Col names in cat_cols/data may only have alphabets/underscore: </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">. Rename cols appropriately.&quot;</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No of interactingCatCols can not exceed cat_cols&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interactingCatCols</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_cols</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interactingCatCols</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_cols</span><span class="p">)),</span> <span class="n">msg</span> 
        
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interactingCatCols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="p">[</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactingCatCols</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_cols</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;interactingCatCols can not have any col not included in cat_col.&quot;</span><span class="p">)</span>
                
        
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">noOfColsToConcat</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span><span class="s2">&quot;In this ver noOfColsToConcat can only be 2&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampsize</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;sampsize be &lt; 1. Ignored when n_iter is 1&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;verbose should minimum 1&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveGraph</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelsPath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;modelsPath can not be None when n_iter &gt; 1 as maps are saved to folder.&quot;</span>
        <span class="n">u</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>   <span class="c1"># No function object specified</span>
            <span class="k">assert</span> <span class="n">u</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">,</span> <span class="s2">&quot;cMeasures improperly specified&quot;</span>
            
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;cutoff can not be 0 or negative. Default is 10.&quot;</span> 
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mergelevelsincols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mergelevelsincols</span> <span class="o">=</span> <span class="p">[]</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avoidInteractionFeatures</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avoidInteractionFeatures</span> <span class="o">=</span> <span class="p">[]</span>

            
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mergelevelsincols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mergethreshold</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">,</span> <span class="s2">&quot;mergethreshold can not be none&quot;</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mergelevelsincols</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mergethreshold</span><span class="p">)</span> <span class="p">,</span> <span class="s2">&quot;Mismatch between lengths of mergelevelsincols and mergethreshold&quot;</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">,</span> <span class="s2">&quot;Number if iterations, n_iter must be more than 1&quot;</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapDictPath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;mapDictPath can not be None when mergelevelsincols is not None&quot;</span>

        <span class="k">return</span></div>
        
        
    
    
<div class="viewcode-block" id="CatEncodersFamily._checkMissing"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._checkMissing">[docs]</a>    <span class="k">def</span> <span class="nf">_checkMissing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: fit()</span>
<span class="sd">        Calls: None</span>
<span class="sd">        </span>
<span class="sd">        Does X has any missing value?</span>
<span class="sd">        Raises an exception if it does</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas DataFrame</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Data has missing values. Fill them up first&quot;</span><span class="p">)</span>
        <span class="k">return</span>    </div>
            
        
    
<div class="viewcode-block" id="CatEncodersFamily.transform"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: main()</span>
<span class="sd">        Calls:  _interactionCols(), _loadStoredModels(), _reduceMemUsage()   </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas DataFrame having only cat cols</span>
<span class="sd">        y : numpy array or pandas Series.Target feature.</span>
<span class="sd">            The default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        X : Transformed DataFrame along with original cat columns.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make a copy so as not to change</span>
        <span class="c1">#  orig data</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mergelevelsincols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span> 
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updateLevels</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;encoding_&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;catEncoder must be fitted&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Pass a pandas DataFrame&quot;</span><span class="p">)</span>    
        
        <span class="n">ncols</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
               
        <span class="n">X</span><span class="p">,</span> <span class="n">nc_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interactionCols</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
         
        <span class="c1"># sorting both the lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_cols_</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">nc_</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
         
        <span class="k">if</span> <span class="n">nc_</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_cols_</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There is some error.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aborting transform..&quot;</span><span class="p">)</span>
            <span class="k">return</span>
             
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadStoredModels</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">avg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg</span><span class="p">)</span>
         
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_cols_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_cols_</span><span class="p">)</span>
         
        <span class="c1"># Change data type from float64 to float32</span>
        <span class="c1"># of only additional columns</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reduceMemUsage</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">fromIndex</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span></div>
   
    
   
<div class="viewcode-block" id="CatEncodersFamily._interactionCols"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._interactionCols">[docs]</a>    <span class="k">def</span> <span class="nf">_interactionCols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       </span>
<span class="sd">        Called by: fit()</span>
<span class="sd">        Calls:     _createCatPairwiseCols()</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X       : pandas DataFrame</span>
<span class="sd">        catCols : list of Categorical columns </span>
<span class="sd">        interactingCatCols : list of categorical columns that </span>
<span class="sd">                             will be concatenated to produce new columns </span>
<span class="sd">        interaction  : boolean. Should there be interaction. </span>
<span class="sd">        noOfColsToConcat : int; At a time noOfColsToConcat columns will </span>
<span class="sd">                                get concatenated. The default is 2.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        X        : pandas dataframe with additional cols created</span>
<span class="sd">        new_cols : list of new column names.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="p">):</span>
            <span class="c1"># All columns including float/int etc</span>
            <span class="n">current_train_columns_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="c1"># 6.1 Create new columns (combinations of cat columns) in train</span>
            <span class="c1">#     Of noOfColsToConcat</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createCatPairwiseCols</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="c1"># 6.12 New columns created. These columns must be latter dropped</span>
            <span class="n">nc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">current_train_columns_</span><span class="p">)))</span>
            <span class="c1"># 6.13 Revised cat cols (ie excluding hour etc)</span>
        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">nc</span></div>



<div class="viewcode-block" id="CatEncodersFamily._createCatPairwiseCols"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._createCatPairwiseCols">[docs]</a>    <span class="k">def</span> <span class="nf">_createCatPairwiseCols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: _interactionCols()</span>
<span class="sd">        Calls    : None   </span>
<span class="sd">        </span>
<span class="sd">        Desc</span>
<span class="sd">        ----------</span>
<span class="sd">            </span>
<span class="sd">        Given a dataframe, df, and a list of categorical</span>
<span class="sd">        columns (cat_cols), this method creates all</span>
<span class="sd">        combinations (not permutations) of supplied columns in pair</span>
<span class="sd">        of two). It then creates new columns in &#39;df&#39; as</span>
<span class="sd">        concatenation of each pair. The resulting dataframe is</span>
<span class="sd">        returned.</span>
<span class="sd">        </span>
<span class="sd">        Example; cat_cols = [var1,var2,var3]</span>
<span class="sd">        New columns created in df: [var1_p_var2,var1_p_var3,var2_p_var3].</span>
<span class="sd">        Existing columns continue to remain as they are.</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        df: pandas DataFrame</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas DataFrame</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Return 2-length subsequences of elements from cat_cols</span>
        <span class="n">x_</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interactingCatCols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noOfColsToConcat</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_</span><span class="p">:</span>
            <span class="c1"># Differentiate permuted column names from names</span>
            <span class="c1">#  created as colToProject+&quot;_+intermediaryCol</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_p_&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># New column name</span>
            <span class="n">df</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>
    
    
<div class="viewcode-block" id="CatEncodersFamily._permuteColList"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._permuteColList">[docs]</a>    <span class="k">def</span> <span class="nf">_permuteColList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">colNamesList</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: fit()</span>
<span class="sd">        Calls    : None</span>
<span class="sd">        </span>
<span class="sd">        Desc</span>
<span class="sd">        ----</span>
<span class="sd">            </span>
<span class="sd">        Given a list of columnnames (colNamesList), the</span>
<span class="sd">        method creates tuples after permuting column names</span>
<span class="sd">        &#39;n&#39; at a time. Presently n = 2 is only supported.</span>

<span class="sd">        Example: </span>
<span class="sd">            colNamesList = [&quot;C1&quot;, &quot;C2&quot;, &quot;C3&quot;]</span>
<span class="sd">            Return list is: [(&quot;C1&quot;, &quot;C2&quot;, cMeasures),</span>
<span class="sd">                             (&quot;C2&quot;, &quot;C1&quot;, cMeasures),...]</span>

<span class="sd">           Including cMeasures in the tuple is a relic from</span>
<span class="sd">           the past when we had only functions and no python</span>
<span class="sd">           Class.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        colNamesList: A list of DataFrame columns to be permuted</span>
<span class="sd">                n: int; n-length tuples, all possible orderings, </span>
<span class="sd">                   no repeated elements </span>

<span class="sd">        Returns:</span>
<span class="sd">        -------  </span>
<span class="sd">        A list of permuted column names</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Permute 2 at a time</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">colNamesList</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
        <span class="n">nl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pc</span><span class="p">:</span>
            <span class="c1"># Get back names</span>
            <span class="n">colToProject</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">intermediaryCol</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># Create a tuple. Add elements True and False</span>
                <span class="c1"># True: Calculate centrality measures</span>
                <span class="c1"># False: No clustering</span>
                <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">colToProject</span><span class="p">,</span><span class="n">intermediaryCol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">intermediaryCol1</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">intermediaryCol2</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">colToProject</span><span class="p">,</span><span class="n">intermediaryCol1</span><span class="p">,</span> <span class="n">intermediaryCol2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not possible&quot;</span><span class="p">)</span>
    
            <span class="n">nl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nl</span>    </div>
    
   
    <span class="c1"># 28th July Removed the comma</span>
<div class="viewcode-block" id="CatEncodersFamily._cleanup"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span> <span class="p">,</span> <span class="n">single_permute_list_</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        From every pair of columns of (colToProject,intermediaryCol),</span>
<span class="sd">        in the list, remove that pair where number of unique values </span>
<span class="sd">        in colToProject are below or equalto a cutoff. default is 10.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas DataFrame </span>
<span class="sd">        single_permute_list_ : A list of tuples</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mylist : A cleaned up list with some tuples removed</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">mylist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># For every tuple (colToProject,intermediaryCol) </span>
        <span class="c1">#  in single_permute_list_</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">single_permute_list_</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avoidInteractionFeatures</span> <span class="ow">and</span> <span class="s2">&quot;_p_&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">continue</span> 
            <span class="c1"># get no of unique values in colToProject </span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
            <span class="c1"># Only if n exceeds a limit,</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">:</span>
                <span class="c1"># we will consider the tuple</span>
                <span class="n">mylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mylist</span></div>
    
    
    
<div class="viewcode-block" id="CatEncodersFamily._getStoreFeatures"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._getStoreFeatures">[docs]</a>    <span class="k">def</span> <span class="nf">_getStoreFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">train</span><span class="p">,</span> <span class="n">record_sets</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: fit()</span>
<span class="sd">        Calls    : _featureEngTrainTest()</span>
<span class="sd">        </span>
<span class="sd">        Desc</span>
<span class="sd">        ----</span>
<span class="sd">    </span>
<span class="sd">        The method invokes method _featureEngTrainTest() to transform train</span>
<span class="sd">        cat features to dense vectors (float). </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        </span>
<span class="sd">        train: pandas DataFrame. It  is the dataset from which, at a time, a pair </span>
<span class="sd">               of cat-features is taken, and then levels from one of the </span>
<span class="sd">               two cat features (say, the first) are mapped to dense vectors.</span>
<span class="sd">        </span>
<span class="sd">               A transformation dictionary (also called transformation model) </span>
<span class="sd">               is created that records levels-to-vectors transformation.</span>
<span class="sd">        </span>
<span class="sd">               The transformation-model has levels as row-indicies. This model </span>
<span class="sd">               is then applied to both train and test. </span>
<span class="sd">        </span>
<span class="sd">        record_sets: list. It is a list of tuples. For iris dataset, assuming, </span>
<span class="sd">                          all 4 features are discrete, it could be something as:</span>
<span class="sd">            </span>
<span class="sd">            [ </span>
<span class="sd">                  (&#39;sep_len&#39;, &#39;sep_wd&#39;,  [1, 1, 1, 0, None,0,0 ]),</span>
<span class="sd">                  (&#39;sep_len&#39;, &#39;pet_len&#39;, [1, 1, 1, 0, None,0,0 ]),</span>
<span class="sd">                  (&#39;sep_len&#39;, &#39;pet_wd&#39;,  [1, 1, 1, 0, None,0,0 ]),</span>
<span class="sd">                  (&#39;sep_wd&#39;,  &#39;sep_len&#39;, [1, 1, 1, 0, None,0,0 ]),</span>
<span class="sd">                  (&#39;sep_wd&#39;,  &#39;pet_len&#39;, [1, 1, 1, 0, None,0,0 ]),</span>
<span class="sd">                  (&#39;sep_wd&#39;,  &#39;pet_wd&#39;,  [1, 1, 1, 0, None,0,0 ]),</span>
<span class="sd">                  (&#39;pet_len&#39;, &#39;sep_len&#39;, [1, 1, 1, 0, None,0,0 ]),</span>
<span class="sd">                  (&#39;pet_len&#39;, &#39;sep_wd&#39;,  [1, 1, 1, 0, None,0,0 ]),</span>
<span class="sd">                  (&#39;pet_len&#39;, &#39;pet_wd&#39;,  [1, 1, 1, 0, None,0,0 ]),</span>
<span class="sd">                  (&#39;pet_wd&#39;,  &#39;sep_len&#39;, [1, 1, 1, 0, None,0,0 ]),</span>
<span class="sd">                  (&#39;pet_wd&#39;,  &#39;sep_wd&#39;,  [1, 1, 1, 0, None,0,0 ]),</span>
<span class="sd">                  (&#39;pet_wd&#39;,  &#39;pet_len&#39;, [1, 1, 1, 0, None,0,0 ])</span>
<span class="sd">           ]</span>
<span class="sd">            </span>
<span class="sd">        Third element in every tuple is cMeasures. Why? When we had only</span>
<span class="sd">        functions and no python Class, we needed this IIIrd element.</span>
<span class="sd">        Presently this is redundant.           </span>
<span class="sd">       </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        Returns nothing. Keeps dictionaries in RAM or Saves models to disk. </span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="c1"># When working in a loop. automatically generate a Different</span>
        <span class="c1">#  progress recording file, each time.</span>
    
        <span class="n">progress_file</span> <span class="o">=</span> <span class="s2">&quot;progress.csv&quot;</span>
    
        <span class="c1"># If this folder does not exist, create one</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathToStoreProgress</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="n">progress_file</span>
        <span class="c1"># Check if progress.csv file exists</span>
        <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="c1"># Get current time</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">dt_string</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="c1"># Replace colons with blank</span>
            <span class="n">dt_string</span> <span class="o">=</span> <span class="n">dt_string</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># Name the progress file</span>
            <span class="n">progress_file</span> <span class="o">=</span> <span class="s2">&quot;progress&quot;</span> <span class="o">+</span> <span class="n">dt_string</span> <span class="o">+</span><span class="s2">&quot;.csv&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myfile</span><span class="p">:</span>
            <span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;sno,ProcessingColToProject,noOfUniqueValues_colToProject, intermediaryCol,noOfUniqueValues_intermediaryCol,time_started,full_list_repeat_no,timetaken&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">record_sets</span><span class="p">):</span>
                <span class="n">colToProject</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">intermediaryCol</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1">#cMeasures = i[2]       # A relic from past code. We ignore this</span>
                <span class="n">start1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="c1"># Write to console and to progress.csv</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Next: &quot;</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span> <span class="p">,</span> <span class="s2">&quot; of &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">record_sets</span><span class="p">),</span> <span class="n">colToProject</span><span class="p">,</span> <span class="n">intermediaryCol</span> <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========================&quot;</span><span class="p">)</span>
                <span class="c1"># This helps track down the point of crash if program crashes</span>
                <span class="n">c1</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">colToProject</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">intermediaryCol</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
                <span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">colToProject</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span><span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">+</span> <span class="n">intermediaryCol</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span><span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">myfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">_featureEngTrainTest</span><span class="p">(</span><span class="n">train</span><span class="p">,</span><span class="n">colToProject</span><span class="p">,</span> <span class="n">intermediaryCol</span><span class="p">)</span>
                <span class="n">end1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">time_taken</span> <span class="o">=</span> <span class="p">(</span><span class="n">end1</span><span class="o">-</span><span class="n">start1</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span>
                <span class="c1">#print(&quot;train columns: &quot;, len(train.columns))</span>
                <span class="c1"># Write more information on colcole and to file progress.csv                    </span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done with&quot;</span><span class="p">,</span> <span class="n">colToProject</span><span class="p">,</span><span class="s2">&quot; and &quot;</span><span class="p">,</span> <span class="n">intermediaryCol</span><span class="p">)</span>
                <span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">time_taken</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># Can be used in an Excel file</span>
                <span class="n">myfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time taken: &quot;</span><span class="p">,</span> <span class="n">time_taken</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Entry made in file progress.csv&quot;</span><span class="p">)</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">return</span>        </div>
                



    <span class="c1"># Engineers features, transform train and test and save the transformational model.</span>
<div class="viewcode-block" id="CatEncodersFamily._featureEngTrainTest"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._featureEngTrainTest">[docs]</a>    <span class="k">def</span> <span class="nf">_featureEngTrainTest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">train</span><span class="p">,</span><span class="n">colToProject</span><span class="p">,</span> <span class="n">intermediaryCol</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by:  _getStoreFeatures() </span>
<span class="sd">        calls    :  _learn, _storeModel(), _storeModelComm</span>
<span class="sd">        </span>
<span class="sd">        Desc</span>
<span class="sd">        -----    </span>
<span class="sd">        The method calls _learn() to learn a model from &#39;train&#39;. It then </span>
<span class="sd">        calls _storeModel() or _storeModelComm() to save it for subsequent</span>
<span class="sd">        use.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        train: pandas DataFrame; train dataset without target. Used to learn </span>
<span class="sd">               and create models</span>
<span class="sd">        colToProject: string; See project_bipartite_graph() for full desc. Also called</span>
<span class="sd">                      &#39;bottom&#39; nodes</span>
<span class="sd">        intermediaryCol: string; See project_bipartite_graph() for full desc</span>
<span class="sd">                         Also called: &#39;top&#39; nodes</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        Nothing. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">noOfUniqueValues</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">colToProject</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No of unique values in &quot;</span><span class="p">,</span> <span class="n">colToProject</span><span class="p">,</span> <span class="s2">&quot; are: &quot;</span><span class="p">,</span> <span class="n">noOfUniqueValues</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learn</span><span class="p">(</span><span class="n">train</span><span class="p">,</span><span class="n">colToProject</span><span class="p">,</span> <span class="n">intermediaryCol</span><span class="p">)</span>
        <span class="c1">#if self.modelsPath is not None:</span>
        <span class="c1"># Store models to disk in a separate folder.</span>
        <span class="c1">#  Folder must alreday exist</span>
        <span class="c1"># storeModel(train,model, pathToStore)</span>
        <span class="c1"># cMeasures: Centrality measures [1,1,1]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storeModel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_storeModelComm</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model saved&quot;</span><span class="p">)</span>
        <span class="k">return</span>    </div>
    
    
   

<div class="viewcode-block" id="CatEncodersFamily._storeModel"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._storeModel">[docs]</a>    <span class="k">def</span> <span class="nf">_storeModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: _featureEngTrainTest()</span>
<span class="sd">        Calls    : None</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">    </span>
<span class="sd">        model: list; Appends, at each call, one dict to &#39;model&#39;. Else, saves</span>
<span class="sd">               at each call one DataFrame to disk as .pkl file. When n_iter = 1</span>
<span class="sd">               &#39;model&#39; is a list of dictionaries . Each dict has levels of a cat</span>
<span class="sd">               column as keys and one of the centality measure as value.</span>
<span class="sd">               Each dictionary maybe transformed to a dataframe and then saved</span>
<span class="sd">               to disk as a pkl file. For more information, please see under </span>
<span class="sd">               _genModel().</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># For dynamic variables.</span>
        <span class="c1"># myvar stores proposed fileName when the model is stored to disk</span>
        <span class="n">myvar</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">intermediaryCol</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># len(model)-1 is the index of last point</span>
        <span class="n">colToProject</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>     <span class="c1"># len(model)-2 is the index of last but one point</span>
        <span class="c1">#cMeasures = model[len(model)-3]        # A relic from past code. We ignore this.</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
            <span class="c1"># Degree related DataFrame model:</span>
            <span class="n">modelName1</span> <span class="o">=</span> <span class="s1">&#39;deg_&#39;</span><span class="o">+</span><span class="n">colToProject</span><span class="o">+</span><span class="s2">&quot;_ck_&quot;</span><span class="o">+</span><span class="n">intermediaryCol</span>
            <span class="c1"># Note &quot;modelName1&quot; is a string while modelName1 is a variable</span>
            <span class="n">myvar</span><span class="p">[</span><span class="s2">&quot;modelName1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modelName1</span>
            <span class="c1"># Our deg-model as a DataFrame</span>
            <span class="c1"># colToProject is the key and modelName1 is the value in dictionary</span>
            <span class="c1"># See Expt4 below</span>
            <span class="n">deg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">colToProject</span><span class="p">,</span><span class="n">modelName1</span><span class="p">])</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">modelName1</span> <span class="o">=</span> <span class="kc">None</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
            <span class="c1"># eigenvector related model as a DataFrame</span>
            <span class="n">modelName2</span> <span class="o">=</span> <span class="s1">&#39;eig_&#39;</span><span class="o">+</span><span class="n">colToProject</span> <span class="o">+</span><span class="s2">&quot;_ck_&quot;</span> <span class="o">+</span><span class="n">intermediaryCol</span>
            <span class="c1"># &quot;modelName2&quot; is a string while modelName2 is a variable</span>
            <span class="n">myvar</span><span class="p">[</span><span class="s2">&quot;modelName2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modelName2</span>
            <span class="n">eig</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">colToProject</span><span class="p">,</span><span class="n">modelName2</span><span class="p">])</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">modelName2</span> <span class="o">=</span> <span class="kc">None</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
            <span class="c1"># pagerank related model as a DataFrame</span>
            <span class="n">modelName3</span> <span class="o">=</span> <span class="s1">&#39;pr_&#39;</span><span class="o">+</span><span class="n">colToProject</span> <span class="o">+</span><span class="s2">&quot;_ck_&quot;</span> <span class="o">+</span> <span class="n">intermediaryCol</span>
            <span class="c1"># &quot;modelName3&quot; is a string while modelName3 is a variable</span>
            <span class="n">myvar</span><span class="p">[</span><span class="s2">&quot;modelName3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modelName3</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">colToProject</span><span class="p">,</span><span class="n">modelName3</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modelName3</span> <span class="o">=</span> <span class="kc">None</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># We evaluate clustering coeff</span>
                <span class="n">modelName4</span> <span class="o">=</span> <span class="s1">&#39;clu_&#39;</span><span class="o">+</span><span class="n">colToProject</span> <span class="o">+</span><span class="s2">&quot;_ck_&quot;</span> <span class="o">+</span> <span class="n">intermediaryCol</span>
                <span class="c1"># &quot;modelName4&quot; is a string while modelName4 is a variable</span>
                <span class="n">myvar</span><span class="p">[</span><span class="s2">&quot;modelName4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modelName4</span>
                <span class="n">clu</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">colToProject</span><span class="p">,</span><span class="n">modelName4</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We evaluate some other node charteristics</span>
                <span class="n">modelName4</span> <span class="o">=</span> <span class="s1">&#39;nf_&#39;</span><span class="o">+</span><span class="n">colToProject</span> <span class="o">+</span><span class="s2">&quot;_ck_&quot;</span> <span class="o">+</span> <span class="n">intermediaryCol</span>
                <span class="c1"># &quot;modelName4&quot; is a string while modelName4 is a variable</span>
                <span class="n">myvar</span><span class="p">[</span><span class="s2">&quot;modelName4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modelName4</span>
                <span class="n">nf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">colToProject</span><span class="p">,</span><span class="n">modelName4</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modelName4</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
            <span class="c1"># betweenness related model as a DataFrame</span>
            <span class="n">modelName5</span> <span class="o">=</span> <span class="s1">&#39;bet_&#39;</span><span class="o">+</span><span class="n">colToProject</span> <span class="o">+</span><span class="s2">&quot;_ck_&quot;</span> <span class="o">+</span> <span class="n">intermediaryCol</span>
            <span class="c1"># &quot;modelName5&quot; is a string while modelName5 is a variable</span>
            <span class="n">myvar</span><span class="p">[</span><span class="s2">&quot;modelName5&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modelName5</span>
            <span class="n">bet</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">colToProject</span><span class="p">,</span><span class="n">modelName5</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modelName5</span> <span class="o">=</span> <span class="kc">None</span>  
            
            
        <span class="c1"># Example cMeasures = [1,1,1,1,None,1,1]</span>
        <span class="c1"># Select dataframe (ldf) that will be on the left</span>
        <span class="c1">#  len(cMeasures)-1 = Exclude the last function name</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span>   <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">modelName1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span> <span class="p">:</span>
                <span class="n">ldf</span> <span class="o">=</span> <span class="n">deg</span>    <span class="c1"># Left data frame for merging below</span>
            <span class="k">elif</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">modelName2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="n">ldf</span> <span class="o">=</span> <span class="n">eig</span>
            <span class="k">elif</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">modelName3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="n">ldf</span> <span class="o">=</span> <span class="n">pr</span>
            <span class="k">elif</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">modelName4</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">ldf</span> <span class="o">=</span> <span class="n">clu</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ldf</span> <span class="o">=</span> <span class="n">nf</span>
            <span class="k">elif</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">modelName5</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>      
                <span class="n">ldf</span> <span class="o">=</span> <span class="n">bet</span>
 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ldf</span> <span class="o">=</span> <span class="kc">None</span>
    
            <span class="k">if</span> <span class="n">ldf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># No need to save anything</span>
                <span class="k">continue</span>
    
            <span class="c1"># An arbitrary file that we do not expect to exist</span>
            <span class="n">my_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">30000</span><span class="p">,</span><span class="mi">40000</span><span class="p">)))</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modelsPath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># Merge left dataframe with current model</span>
                <span class="c1">#  (i+1) becuase modelName starts with modelName1</span>
                <span class="n">current_model</span> <span class="o">=</span> <span class="s2">&quot;modelName&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">filename</span> <span class="o">=</span>  <span class="n">myvar</span><span class="p">[</span><span class="n">current_model</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.pkl&quot;</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modelsPath</span><span class="p">)</span>
                <span class="n">my_file</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="n">filename</span>

            
            <span class="c1"># If the model file was earlier saved and it exists</span>
            <span class="k">if</span> <span class="n">my_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>   
                <span class="c1"># Read earlier the saved file</span>
                <span class="n">saved_file</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">my_file</span><span class="p">)</span>
                <span class="c1"># Rename ldf column by adding a random number to column</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_integers</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>  <span class="c1"># Generate a random number</span>
                <span class="c1"># Rename column of ldf. str(1) below is not needed. May be removed.</span>
                <span class="n">ldf</span> <span class="o">=</span> <span class="n">ldf</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">myvar</span><span class="p">[</span><span class="n">current_model</span><span class="p">]</span>  <span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))})</span>

                <span class="c1"># Merge it with the current file:</span>
                <span class="c1"># Before merging make dtypes same:</span>
                <span class="c1">#ldf[colToProject] = ldf[colToProject].astype(str)</span>
                <span class="c1">#saved_file.index = saved_file.index.astype(str)</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ldf</span> <span class="p">,</span>                   <span class="c1"># Dataframe on the left</span>
                              <span class="n">saved_file</span><span class="p">,</span>             <span class="c1"># Dataframe on the right</span>
                              <span class="n">left_on</span> <span class="o">=</span> <span class="n">colToProject</span><span class="p">,</span> <span class="c1"># Name of column of ldf</span>
                              <span class="n">right_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>     <span class="c1"># Index of saved_file</span>
                              <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;outer&#39;</span>
                              <span class="p">)</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">colToProject</span><span class="p">)</span>
    
                <span class="c1"># Save it back to disk. Overwrite existing file.</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">my_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This is the first time</span>
                <span class="c1"># ldf would contain only one column.</span>
                <span class="c1"># colToProject would become named index</span>
                <span class="n">ldf</span> <span class="o">=</span> <span class="n">ldf</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">colToProject</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">modelList_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ldf</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;tight&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ldf</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">my_file</span><span class="p">)</span>
        
        <span class="k">return</span>            </div>
                
                    
                    
    <span class="c1"># Folder pathToStoreModel must exist</span>
<div class="viewcode-block" id="CatEncodersFamily._storeModelComm"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._storeModelComm">[docs]</a>    <span class="k">def</span> <span class="nf">_storeModelComm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: _featureEngTrainTest()</span>
<span class="sd">        Calls    : None</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">    </span>
<span class="sd">        model:  list; This object is a list of dictionaries.</span>
<span class="sd">                 For more information, please see</span>
<span class="sd">                 under _genModel(). Each dictionary</span>
<span class="sd">                 is saved as a dataframe in a pkl file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># For dynamic variables.</span>
        <span class="c1"># myvar stores proposed fileName as the model will be stored to disk</span>
        <span class="n">myvar</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">intermediaryCol</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># len(model)-1 is the index of last point</span>
        <span class="n">colToProject</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>     <span class="c1"># len(model)-2 is the index of last but one point</span>
        <span class="n">modelName6</span> <span class="o">=</span> <span class="s1">&#39;gr_&#39;</span><span class="o">+</span><span class="n">colToProject</span>  <span class="o">+</span><span class="s2">&quot;_ck_&quot;</span> <span class="o">+</span> <span class="n">intermediaryCol</span>
        <span class="n">modelName7</span> <span class="o">=</span> <span class="s1">&#39;ae_&#39;</span><span class="o">+</span><span class="n">colToProject</span> <span class="o">+</span><span class="s2">&quot;_ck_&quot;</span> <span class="o">+</span> <span class="n">intermediaryCol</span>
        <span class="n">modelName8</span> <span class="o">=</span> <span class="s1">&#39;den_&#39;</span><span class="o">+</span><span class="n">colToProject</span> <span class="o">+</span><span class="s2">&quot;_ck_&quot;</span> <span class="o">+</span> <span class="n">intermediaryCol</span>
        
        <span class="c1"># &quot;modelName6&quot; is a string while modelName6 is a variable</span>
        <span class="n">myvar</span><span class="p">[</span><span class="s2">&quot;modelName6&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modelName6</span>
        <span class="n">myvar</span><span class="p">[</span><span class="s2">&quot;modelName7&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modelName7</span>
        <span class="n">myvar</span><span class="p">[</span><span class="s2">&quot;modelName8&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modelName8</span>
        <span class="k">if</span> <span class="n">model</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#gr = pd.DataFrame.from_records(np.array(list(model[5].items())), columns=[colToProject,modelName6])</span>
            <span class="n">ae</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">colToProject</span><span class="p">,</span><span class="n">modelName7</span><span class="p">])</span>
            <span class="n">den</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">colToProject</span><span class="p">,</span><span class="n">modelName8</span><span class="p">])</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span><span class="n">ae</span><span class="p">,</span><span class="n">den</span><span class="p">)):</span>    <span class="c1"># Instead of ((gr,ae,den))</span>
                <span class="n">ldf</span> <span class="o">=</span> <span class="n">j</span>
                
                <span class="c1"># An arbitrary file that we do not expect to exist</span>
                <span class="n">my_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">30000</span><span class="p">,</span><span class="mi">40000</span><span class="p">)))</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modelsPath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">current_model</span> <span class="o">=</span> <span class="s2">&quot;modelName&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">filename</span> <span class="o">=</span>  <span class="n">myvar</span><span class="p">[</span><span class="n">current_model</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.pkl&quot;</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modelsPath</span><span class="p">)</span>
                    <span class="n">my_file</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="n">filename</span>
                
                
                <span class="k">if</span> <span class="n">my_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>   
                        <span class="c1"># Read earlier the saved file</span>
                        <span class="n">saved_file</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">my_file</span><span class="p">)</span>
                        <span class="c1"># Rename ldf column by adding a random number to column</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_integers</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>  <span class="c1"># Generate a random number</span>
                        <span class="c1"># Rename column of ldf. str(1) below is not needed. May be removed.</span>
                        <span class="n">ldf</span> <span class="o">=</span> <span class="n">ldf</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">myvar</span><span class="p">[</span><span class="n">current_model</span><span class="p">]</span>  <span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))})</span>
        
                        <span class="c1"># Merge it with the current file:</span>
                        <span class="c1"># Before merging make dtypes same:</span>
                        <span class="c1">#ldf[colToProject] = ldf[colToProject].astype(str)</span>
                        <span class="c1">#saved_file.index = saved_file.index.astype(str)</span>
        
                        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ldf</span> <span class="p">,</span>                   <span class="c1"># Dataframe on the left</span>
                                      <span class="n">saved_file</span><span class="p">,</span>             <span class="c1"># Dataframe on the right</span>
                                      <span class="n">left_on</span> <span class="o">=</span> <span class="n">colToProject</span><span class="p">,</span> <span class="c1"># Name of column of ldf</span>
                                      <span class="n">right_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>     <span class="c1"># Index of saved_file</span>
                                      <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;outer&#39;</span>
                                      <span class="p">)</span>
           
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">colToProject</span><span class="p">)</span>
            
                        <span class="c1"># Save it back to disk. Overwrite existing file.</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">my_file</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># This is the first time</span>
                        <span class="c1"># If community info is also desired</span>
                        <span class="c1"># ldf would contain only one column.</span>
                        <span class="c1"># colToProject would become named index</span>
                        <span class="n">ldf</span> <span class="o">=</span> <span class="n">ldf</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">colToProject</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">modelList_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ldf</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;tight&#39;</span><span class="p">))</span> 
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ldf</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">my_file</span><span class="p">)</span> 
        <span class="k">return</span></div>
                
   
    
     
    <span class="c1"># Creates graphs and builds models based on centrality measures</span>
<div class="viewcode-block" id="CatEncodersFamily._learn"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._learn">[docs]</a>    <span class="k">def</span> <span class="nf">_learn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">colToProject</span><span class="p">,</span> <span class="n">intermediaryCol</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by : _featureEngTrainTest()</span>
<span class="sd">        Calls     : _toNetwork(), _projectBipartiteGraph(), _genModel()</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        colToProject &amp; &#39;intermediaryCol&#39;: </span>
<span class="sd">                     string; Create a bipartite network from two columns of a DataFrame, &#39;df&#39;.</span>
<span class="sd">                     Columns are &#39;colToProject&#39; &amp; &#39;intermediaryCol&#39;. We may also</span>
<span class="sd">                     call them as &#39;bottom&#39; column and &#39;top&#39; column</span>

<span class="sd">        Desc</span>
<span class="sd">        -----</span>
<span class="sd">            _learn() first calls _toNetwork() and then _projectBipartiteGraph</span>
<span class="sd">            to build a projected, unweighted, unipartite network. It then calls</span>
<span class="sd">            _genModel(). And _genModel() calls _calCentralityMeasures() &amp;</span>
<span class="sd">            _calCommunities() to generate and store models.</span>
<span class="sd">    </span>
<span class="sd">            The method transforms the bipartite network to unipartite network.</span>
<span class="sd">            Builds a &#39;model&#39; object of centrality measures. To know more about</span>
<span class="sd">            the &#39;model&#39; object, see help under _genModel().</span>
<span class="sd">            The method also stores our graph related performance data</span>
<span class="sd">            in file &quot;networkPerformanceData.csv&quot;. </span>
<span class="sd">    </span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="c1"># Transform to bipartite network</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toNetwork</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">colToProject</span><span class="p">,</span> <span class="n">intermediaryCol</span><span class="p">)</span>
        <span class="c1"># Save bipartite graph to disk</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveGraph</span><span class="p">):</span>
            <span class="c1">#self._saveBipartiteGraphToDisk(G, colToProject, intermediaryCol)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saveGraphToDisk</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">colToProject</span><span class="p">,</span> <span class="n">intermediaryCol</span><span class="p">,</span> <span class="n">bipartite</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            
        <span class="n">end1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="p">(</span><span class="n">end1</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bipartite Network created. Time taken: &quot;</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="s2">&quot;minutes&quot;</span><span class="p">)</span>
        <span class="c1"># Project bipartite network to unipartite. projection</span>
        <span class="c1"># results in connected graph of nodes in colToProject.</span>
        <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_projectBipartiteGraph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">colToProject</span><span class="p">)</span>
        <span class="c1"># Save unipartite graph to disk</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveGraph</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saveGraphToDisk</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">colToProject</span><span class="p">,</span> <span class="n">intermediaryCol</span><span class="p">,</span> <span class="n">bipartite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">end2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">tt1</span> <span class="o">=</span> <span class="p">(</span><span class="n">end2</span><span class="o">-</span><span class="n">end1</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bipartite Network projected. Time taken: &quot;</span><span class="p">,</span> <span class="n">tt1</span><span class="p">,</span> <span class="s2">&quot;minutes&quot;</span> <span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    
        <span class="c1"># Calculate Centrality mesaures and build model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_genModel</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">colToProject</span><span class="p">,</span> <span class="n">intermediaryCol</span><span class="p">)</span>
        <span class="n">end3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">tt2</span> <span class="o">=</span> <span class="p">(</span><span class="n">end3</span><span class="o">-</span><span class="n">end2</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model extracted. Time taken: &quot;</span><span class="p">,</span> <span class="n">tt2</span><span class="p">,</span> <span class="s2">&quot;minutes&quot;</span> <span class="p">)</span>
    
        <span class="c1"># Save time related information in a file</span>
        <span class="n">netfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathToStoreProgress</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;networkPerformanceData.csv&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">netfile</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tt1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tt2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">colToProject</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">intermediaryCol</span><span class="p">)</span> <span class="o">+</span>  <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">model</span></div>
    


    <span class="c1"># Network creation and manipulation</span>
    <span class="c1"># Transform a pair of dataframe columns to a network</span>
<div class="viewcode-block" id="CatEncodersFamily._toNetwork"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._toNetwork">[docs]</a>    <span class="k">def</span> <span class="nf">_toNetwork</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">colToProject</span><span class="p">,</span><span class="n">intermediaryCol</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by : _learn()</span>
<span class="sd">        Calls     : None</span>
<span class="sd">        </span>
<span class="sd">        Desc</span>
<span class="sd">        ----</span>
<span class="sd">        Given a datafarme, df, with two columns, colToProject</span>
<span class="sd">        and intermediaryCol, create a bipartite undirected network.</span>
<span class="sd">        Values in both the columns serve as labels for two kinds of nodes.</span>
<span class="sd">        Network has two kinds of nodes: one category comprises labels</span>
<span class="sd">        in colToProject and the other set comprises labels in</span>
<span class="sd">        intermediaryCol. Every tuple in the DataFrame (colToProject,intermediaryCol)</span>
<span class="sd">        is an edge connecting the two kinds of nodes.</span>
<span class="sd">        (This situation contrasts with dataframe having two columns but nodes</span>
<span class="sd">         in the two columns are of same kind.)</span>
<span class="sd">        Before creating bipartite graph, dtypes of both colToProject and </span>
<span class="sd">        intermediaryCol are transformed to string types.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df: pandas DataFrame</span>
<span class="sd">        colToProject: string; This column holds nodes for the graph. &#39;Bottom&#39; col</span>
<span class="sd">        intermediaryCol: string; This column holds another set of nodes for graph</span>
<span class="sd">                         &#39;Top&#39; column. See project_bipartite_graph() for full desc</span>
<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        A bipartite graph object with two kinds of nodes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># MAke a copy to avoid getting notification:</span>
        <span class="c1"># &quot;A value is trying to be set on a copy of a slice from a DataFrame.&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">colToProject</span><span class="p">,</span><span class="n">intermediaryCol</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Distinguish the two types of nodes.</span>
        <span class="c1">#  Else, there is confusion if both are integers and both cols</span>
        <span class="c1">#   may have nodes with same integer number</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">intermediaryCol</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">):</span>
            <span class="n">s</span><span class="p">[</span><span class="n">intermediaryCol</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">intermediaryCol</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
        <span class="n">s</span><span class="p">[</span><span class="n">intermediaryCol</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;inter_&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">intermediaryCol</span><span class="p">]</span>  <span class="c1"># prefix &#39;inter_&#39;</span>
        <span class="c1"># As we are dealing with categorical data, even if nodes are integers</span>
        <span class="c1">#  we may transform them to string. This will facilitate model</span>
        <span class="c1">#    storage problems</span>
        <span class="c1"># Amended on 9th Dec, 2022</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">colToProject</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">):</span>
            <span class="n">s</span><span class="p">[</span><span class="n">colToProject</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">colToProject</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
            
        <span class="c1"># List of nodes of one category</span>
        <span class="n">nodes1</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">colToProject</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">nodes1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nodes1</span><span class="p">)</span>
        <span class="c1"># List of nodes of another category</span>
        <span class="n">nodes2</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">intermediaryCol</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">nodes2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nodes2</span><span class="p">)</span>
        <span class="c1"># Every tuple in the dataframe is an edge. So get list of edge-tuples</span>
        <span class="c1">#  Also drop duplicate edges</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">colToProject</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="n">intermediaryCol</span><span class="p">])))</span>
        <span class="c1"># Create an empty graph object</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="c1"># Create a bipartite graph</span>
        <span class="c1"># https://networkx.org/documentation/stable/reference/algorithms/bipartite.html</span>
        <span class="c1"># Add nodes with the node attribute &quot;bipartite&quot;</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">nodes1</span><span class="p">,</span> <span class="n">bipartite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">nodes2</span><span class="p">,</span> <span class="n">bipartite</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Add edges only between nodes of opposite node sets</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">graph</span></div>



<div class="viewcode-block" id="CatEncodersFamily._projectBipartiteGraph"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._projectBipartiteGraph">[docs]</a>    <span class="k">def</span> <span class="nf">_projectBipartiteGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bi_network</span><span class="p">,</span><span class="n">colToProject</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by:  _learn()</span>
<span class="sd">        Calls    :  None</span>
<span class="sd">        </span>

<span class="sd">        Desc</span>
<span class="sd">        ----</span>
<span class="sd">        Bipartitie Projection: Projection is a common operation for bipartite</span>
<span class="sd">        graphs that converts a bipartite graph into a regular graph. There are</span>
<span class="sd">        two types of projections: top and bottom projections. Top projection</span>
<span class="sd">        preserves only top nodes in the result graph and creates a link between</span>
<span class="sd">        them in a new graph only if there is an intermediate bottom node both</span>
<span class="sd">        top nodes connect to in the original graph. Bottom projection is the</span>
<span class="sd">        opposite to top projection, i.e. only preserves bottom nodes and connects</span>
<span class="sd">        a pair of nodes if they are connected in the original graph.</span>
<span class="sd">        Our terminlogy for the two types of node-sets are: colToProject &amp;</span>
<span class="sd">        intermediaryCol. After the projection only nodes of colToProject are</span>
<span class="sd">        preserved and edges between them are created as mentioned before.</span>
<span class="sd">        The method projects a bipartite &#39;bi_network&#39; to unipartite network.</span>
<span class="sd">        colToProject nodes are projected. Unipartite network has only</span>
<span class="sd">        df[colToProject] nodes. The operation is time consuming as also</span>
<span class="sd">        RAM consuming.</span>
<span class="sd">        For more information on the problem, see this link:</span>
<span class="sd">           https://datascience.stackexchange.com/a/87232</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bi_network: A bipartite graph object</span>
<span class="sd">        colToProject: String; Column to be projected into graph. Bottom col</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A unipartite graph object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># From the graph retireve that unique set of nodes</span>
        <span class="c1">#  having the &#39;bipartite&#39; property as 0.</span>
        <span class="n">nodes1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">bi_network</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;bipartite&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Return projected network</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multigraph</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bipartite</span><span class="o">.</span><span class="n">projected_graph</span><span class="p">(</span><span class="n">bi_network</span><span class="p">,</span> <span class="n">nodes1</span><span class="p">,</span> <span class="n">multigraph</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bipartite</span><span class="o">.</span><span class="n">projected_graph</span><span class="p">(</span><span class="n">bi_network</span><span class="p">,</span> <span class="n">nodes1</span><span class="p">,</span> <span class="n">multigraph</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span></div>




    <span class="c1"># Given a unipartite network, builds a model of centrality features and community features.</span>
<div class="viewcode-block" id="CatEncodersFamily._genModel"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._genModel">[docs]</a>    <span class="k">def</span> <span class="nf">_genModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">network</span><span class="p">,</span> <span class="n">colToProject</span><span class="p">,</span><span class="n">intermediaryCol</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: _learn()</span>
<span class="sd">        Calls    : _calCentralityMeasures(), _calCommunities()</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        network:  Graph object; Unipartite network after projection of bipartite network</span>
<span class="sd">        colToProject: string; The &#39;network&#39; contains nodes from colToProject. &#39;Bottom&#39; nodes</span>
<span class="sd">        intermediaryCol: string Other sets of nodes in the bipartite network; &#39;Top&#39; nodes</span>

<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List. A model is a list of mixed types of objects.</span>
<span class="sd">        These objects are as follows:</span>
<span class="sd">        model[0] to model[2]: Three dictionaries. For a projected graph, each dictionary</span>
<span class="sd">                              has nodes as keys with one of the three centrality-measures</span>
<span class="sd">                              (deg,eig,pr) as values.</span>
<span class="sd">        model[3] : Either a dictionary, if betweenness is calculated. Else, None</span>
<span class="sd">                   Calculation of betweenness may be time-consuming</span>
<span class="sd">        model[4] : Either a dictionary, if clustering coeff is calcuated. Else None</span>
<span class="sd">        model[5] to model[7]: Either 3-dictionaries having community related information. Else None</span>
<span class="sd">        model[8] : A List: cMeasures. Not used.</span>
<span class="sd">        model[9] : String: name of  colToProject</span>
<span class="sd">        model[10]: String: name of  intermediaryCol</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># cMeasures: [1,1,1,0,None,1,1] ; The last 1 is for discovering community</span>
        <span class="n">model</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">):</span>
            <span class="n">centrality</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">centrality</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="k">if</span> <span class="n">centrality</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calCentralityMeasures</span><span class="p">(</span> <span class="n">model</span> <span class="p">,</span> <span class="n">network</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>    <span class="c1"># model[0] to model[4]: deg,eig,pr,bet,cl_coeff</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multigraph</span><span class="p">:</span>
                <span class="n">network</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
        <span class="c1">#if communities:</span>
            <span class="n">gr</span><span class="p">,</span><span class="n">gr1</span><span class="p">,</span><span class="n">gr2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calCommunities</span><span class="p">(</span><span class="n">network</span><span class="p">,</span><span class="n">colToProject</span><span class="p">,</span><span class="n">intermediaryCol</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">gr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gr</span><span class="p">)</span>     <span class="c1"># model[5]</span>
                <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gr1</span><span class="p">)</span>    <span class="c1"># model[6]</span>
                <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gr2</span><span class="p">)</span>    <span class="c1"># model[7]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>   <span class="c1"># model[5,6,7]</span>
    
        <span class="c1"># We use the following information else where</span>
        <span class="c1">#  So, save it</span>
        <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">)</span>   <span class="c1"># model[8]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colToProject</span><span class="p">)</span>     <span class="c1"># model[9]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intermediaryCol</span><span class="p">)</span>  <span class="c1"># model[10]</span>
    
        <span class="k">return</span> <span class="n">model</span></div>

    
     
    <span class="c1"># For every node in unipartite network, calculate centrality charteristics</span>
<div class="viewcode-block" id="CatEncodersFamily._calCentralityMeasures"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._calCentralityMeasures">[docs]</a>    <span class="k">def</span> <span class="nf">_calCentralityMeasures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">,</span> <span class="n">network</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: _genModel()</span>
<span class="sd">        Calls    : None</span>
<span class="sd">        </span>
<span class="sd">        Desc</span>
<span class="sd">        -----    </span>
<span class="sd">        Given a unipartite undirected network, the method</span>
<span class="sd">        calculates centrality measures per node. Measures</span>
<span class="sd">        calculated are: degree, eigenvector, pagerank, betweenness,</span>
<span class="sd">        Clustering coefficient and others. Instead of clustering coef</span>
<span class="sd">        one may specify a function object to calculate centrality measure.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            a. model is an empty list that will be returned.</span>
<span class="sd">            b. network is a unipartite undirected graph</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Returns one &#39;model&#39;, a list object. This list contains dictionaries</span>
<span class="sd">        or None objects or String elements. Each dictionary has nodes as keys and</span>
<span class="sd">        one of the centrality measure as values. Nodes belong to colToProject.</span>
<span class="sd">        There will be as many dictionaries as centrality measures calculated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Three centrality measures</span>
        <span class="c1"># deg</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">deg</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">degree_centrality</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">deg</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="c1"># MultiGraph is only used in degree calculation </span>
        <span class="c1">#  Revert to Simple Graph</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multigraph</span><span class="p">:</span>
            <span class="n">network</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
        
        <span class="c1"># eig</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">eig</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">eigenvector_centrality_numpy</span><span class="p">(</span><span class="n">network</span><span class="p">)</span> <span class="c1"># Run eigenvector centrality</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">eig</span> <span class="o">=</span> <span class="kc">None</span>
    
        <span class="c1"># pr</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">pr</span>  <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">pagerank</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="kc">None</span>
    
        <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span>   <span class="c1"># model[0]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eig</span><span class="p">)</span>   <span class="c1"># model[1]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>    <span class="c1"># model[2]</span>
    
        <span class="c1"># Calculate Betweenness centrality</span>
        <span class="c1"># Consumes a lot of time.</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># See: https://networkx.org/documentation/networkx-1.10/reference/generated/networkx.algorithms.centrality.betweenness_centrality.html</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating betweenness centrality with k = All nodes&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating betweenness centrality with k = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="si">}</span><span class="s2"> nodes sample&quot;</span><span class="p">)</span>
            <span class="n">bt</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">betweenness_centrality</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Betweenness centrality calculated&quot;</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bt</span><span class="p">)</span>  <span class="c1"># model[3]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># model[3]</span>
    
    
        <span class="c1"># Calculate Clustering coefficient</span>
        <span class="c1">#  Or some specified node_charteristics using</span>
        <span class="c1">#   a pre-specified node charteristics function</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># Calculate clustering coefficient</span>
                <span class="n">node_char</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">clustering</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Apply pre-specified node_char_func</span>
                <span class="n">node_char_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cMeasures</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">node_char</span> <span class="o">=</span> <span class="n">node_char_func</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_char</span><span class="p">)</span>  <span class="c1"># model[4]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>      <span class="c1"># model[4]</span>
    
        <span class="k">return</span> <span class="n">model</span></div>
   
    
    <span class="c1"># Uses cdlib library</span>
<div class="viewcode-block" id="CatEncodersFamily._calCommunities"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._calCommunities">[docs]</a>    <span class="k">def</span> <span class="nf">_calCommunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">network</span><span class="p">,</span><span class="n">colToProject</span><span class="p">,</span> <span class="n">intermediaryCol</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: _genModel()</span>
<span class="sd">        Calls    : None</span>
<span class="sd">        </span>
<span class="sd">        Desc</span>
<span class="sd">        -----</span>
<span class="sd">    </span>
<span class="sd">        The method locates communities in the unipartite network</span>
<span class="sd">        and also calculates two community related measures: density and</span>
<span class="sd">        avg_embeddedness. It returns 3-dictionaries. The first dict indicates </span>
<span class="sd">        which node falls in which community. The other two dictionaries </span>
<span class="sd">        contain node-wise community characteristics.</span>
<span class="sd">        Ref: https://cdlib.readthedocs.io/en/latest/reference/cd_algorithms/algs/cdlib.algorithms.leiden.html#cdlib-algorithms-leiden</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        network: Graph object</span>
<span class="sd">        colToProject: string; A column name. Bottom column </span>
<span class="sd">        intermediaryCol: string; A column name. Top column</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Returns three dictionaries</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">## Clustering</span>
        <span class="c1">## Calculate communites</span>
        <span class="c1"># leiden_coms is a cdlib clustering object</span>
        <span class="c1"># Avoid following msg with try-except:</span>
        <span class="c1"># Disconnected graph: Ambiguous solution for bipartite sets   </span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">leiden_coms</span> <span class="o">=</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">leiden</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
<span class="w">            </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        leiden_coms.communities yields a list of lists. Each</span>
<span class="sd">        innerlist is a community. Its labels (node-labels) are </span>
<span class="sd">        members of same cluster. Thus, total clusters are as many </span>
<span class="sd">        as the size of outer-list. Example of 4-clusters:</span>
<span class="sd">            [</span>
<span class="sd">                 [8, 9, 14, 15, 18, 20, 22, 26, 29, 30, 32, 33],</span>
<span class="sd">                 [0, 1, 2, 3, 7, 11, 12, 13, 17, 19, 21],</span>
<span class="sd">                 [23, 24, 25, 27, 28, 31],</span>
<span class="sd">                 [4, 5, 6, 10, 16]</span>
<span class="sd">            ]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">## And calculate average embedde\ness as alsp density per cluster:</span>
        <span class="c1"># https://cdlib.readthedocs.io/en/latest/reference/eval/cdlib.evaluation.avg_embeddedness.html#cdlib.evaluation.avg_embeddedness</span>
        <span class="c1"># ae cal example: [0.833088235294, 0.861868686868, 0.622222222222, 0.766666666666]</span>
        <span class="c1"># for each of the four clusters</span>
        <span class="n">ae</span> <span class="o">=</span> <span class="n">evaluation</span><span class="o">.</span><span class="n">avg_embeddedness</span><span class="p">(</span><span class="n">network</span><span class="p">,</span><span class="n">leiden_coms</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># density of 4-clusters: [2.288461538461, 3.007692307692, 3.356410256410, 4.31538461538] </span>
        <span class="n">density</span> <span class="o">=</span> <span class="n">leiden_coms</span><span class="o">.</span><span class="n">scaled_density</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="c1"># IDentify which node falls in which cluster.</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># Community count</span>
        <span class="n">gr</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># For every community,i</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leiden_coms</span><span class="o">.</span><span class="n">communities</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1"># For every memeber,j, of community</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;comm&quot;</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">colToProject</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">intermediaryCol</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
                <span class="n">gr</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    
        <span class="c1"># Label each node with its cluster embeddedness </span>
        <span class="n">gr1</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># For every community, i</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leiden_coms</span><span class="o">.</span><span class="n">communities</span><span class="p">:</span>
            <span class="c1"># For every memebr,j, of the community</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">ae</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
                <span class="n">gr1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>     
    
        <span class="c1"># Label each node with its cluster density</span>
        <span class="n">gr2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leiden_coms</span><span class="o">.</span><span class="n">communities</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">density</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
                <span class="n">gr2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">gr</span><span class="p">,</span><span class="n">gr1</span><span class="p">,</span><span class="n">gr2</span></div>
    
  
      
    
    <span class="c1"># Read models stored in a folder and carry out</span>
    <span class="c1">#  transformation</span>
<div class="viewcode-block" id="CatEncodersFamily._loadStoredModels"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._loadStoredModels">[docs]</a>    <span class="k">def</span> <span class="nf">_loadStoredModels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span>   <span class="n">avg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: transform()</span>
<span class="sd">        Calls: _readAllStoredModels()</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">    </span>
<span class="sd">        df          : pandas DataFrame; &#39;train&#39; dataframe. Column names MUST BE </span>
<span class="sd">                      alphabetical only.</span>
<span class="sd">        avg         : boolean; Take an average of stored values. See Explanation.</span>
<span class="sd">        </span>
<span class="sd">        Explanation</span>
<span class="sd">        -----------</span>
<span class="sd">    </span>
<span class="sd">                      This method reads all dictionaries or *.pkl files saved on disk.</span>
<span class="sd">                      in folder modelsPath.  </span>
<span class="sd">                      When n_iter &gt; 1, fFor every, colToProject, it averages </span>
<span class="sd">                      out all encoded values (created iteration-by-iteration) and then merges</span>
<span class="sd">                      with df by adding a column to it.</span>
<span class="sd">        Example:</span>
<span class="sd">        Here are sample contents of a .pkl file &#39;deg_app_ck_app_p_channel&#39;:</span>
<span class="sd">    </span>
<span class="sd">        	3744_5	   7823_4   8167_3    9543_2         deg_app_ck_app_p_channel</span>
<span class="sd">        app</span>
<span class="sd">        27	 0.0	     0.0    0.7      0.13            0.21</span>
<span class="sd">        0	 0.1	     0.0    0.2      0.15            0.11</span>
<span class="sd">        57	 0.0	     0.3    0.5      0.17            0.01</span>
<span class="sd">        303	 0.0	     0.0    0.0      0.00            0.05</span>
<span class="sd">        125	 0.1	     0.2    0.0      0.10            0.34</span>
<span class="sd">        ...	 ...	...  ...   ...     ....           ......</span>
<span class="sd">        41	 NaN	     0.0    NaN      0.0             0.0</span>
<span class="sd">        207	 NaN	     0.0    0.1      0.0             0.1</span>
<span class="sd">        222	 NaN	     0.0    NaN      0.2             0.0</span>
<span class="sd">        381	 NaN	     0.0    NaN      NaN             0.0</span>
<span class="sd">        168	 NaN	     0.0    NaN      NaN             0.3</span>
<span class="sd">    </span>
<span class="sd">        204 rows  20 columns</span>
<span class="sd">    </span>
<span class="sd">        &#39;deg&#39; both in filename as also last col name (&#39;deg_app_ck_app_p_channel&#39;)</span>
<span class="sd">        implies that this file stores degree entrality measure for a unipartite</span>
<span class="sd">        network obtained by projecting a bipartite graph of &#39;app&#39; and &#39;app_p_channel&#39;.</span>
<span class="sd">        &#39;app_p_channel&#39; indicates concatenation of two columns: &#39;app&#39; &amp; channel in</span>
<span class="sd">        the dataset (df). </span>
<span class="sd">        Projection is of &#39;app&#39; nodes. The index of the read *.pkl file contains</span>
<span class="sd">        levels of &#39;app&#39; nodes.</span>
<span class="sd">        During each iteration, we have a different sample and a different</span>
<span class="sd">        projected graph. Thus, degrees of a node may differ from iteration</span>
<span class="sd">        to iteration. Each row contains degree of a particular node and each</span>
<span class="sd">        column has values of degrees for some iteration sample.</span>
<span class="sd">        Column name 9543_2 means this model was created on IInd iteration.</span>
<span class="sd">        This file contains models from six iterations.</span>
<span class="sd">        Dataframe index name &#39;app&#39; is &#39;colToProject&#39;.</span>
<span class="sd">        The method takes row-wise averages resulting in one column. The averaged</span>
<span class="sd">        column is named as deg_app_ck_app_p_channel. Index, &#39;app&#39; is also made a col</span>
<span class="sd">        We now have a dataFrame of two columns that maps colToProject (&#39;app&#39;)</span>
<span class="sd">        to &#39;degree&#39; values (deg_app_ck_app_p_channel).</span>
<span class="sd">        If the averaged column is not a constant (all zeros, for example), this new</span>
<span class="sd">        column is merged with train/test dataframe. Merging is on colToProject (&#39;app&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathToStoreProgress</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;load_stored_models.txt&#39;</span>
        
        <span class="c1"># Read all stored models from &#39;modelsPath&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;====Reading all model-dicts from folder: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">modelsPath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;====Reading all model-dicts from RAM&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">====Takes time...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readAllStoredModels</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">====All saved model-dicts read! Model files are intact!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;====Total model-dict are: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;====Sending model loading progress to file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;When loading is in progress, open this file with notepad++ AND NOT with notepad&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span> <span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># For every model</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transforming with model: &quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="s2">&quot; of: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">),</span> <span class="n">file</span> <span class="o">=</span> <span class="n">f</span><span class="p">)</span>
                <span class="c1"># Create an empty DataFrame</span>
                <span class="n">mymodel</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
                <span class="c1"># Get list of columns in this model</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No of columns: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span> <span class="n">file</span> <span class="o">=</span> <span class="n">f</span><span class="p">)</span>
                <span class="c1"># Which one of it is alpha-betical column name?</span>
                <span class="c1">#  And get colToProject, intermediaryCol</span>
                <span class="n">non_numeric_col</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                    <span class="c1"># Read only that column whose name is alphabetical</span>
                    <span class="c1">#  Is &#39;i&#39; alpha-betical?</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[A-Za-z_]+$&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
                        <span class="c1"># If yes, split it to get colToProject and intermediaryCol</span>
                        <span class="n">colToProject</span><span class="p">,</span> <span class="n">intermediaryCol</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_ck_&quot;</span><span class="p">)</span>
                        <span class="n">colToProject</span> <span class="o">=</span> <span class="n">colToProject</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># From deg_app split, as [deg , app]</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;colToProject is: &quot;</span><span class="p">,</span> <span class="n">colToProject</span><span class="p">,</span> <span class="s2">&quot; and intermediaryCol is: &quot;</span><span class="p">,</span> <span class="n">intermediaryCol</span> <span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">f</span> <span class="p">)</span>
                        <span class="n">non_numeric_col</span> <span class="o">=</span> <span class="n">i</span>  <span class="c1"># &#39;non-numeric&#39; stands for column name not for data type</span>
    
                <span class="c1"># Get average of models across rows</span>
                <span class="c1">#  All columns of model are &#39;object&#39; type</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
                <span class="c1"># To mymodel, add a column with mean-values</span>
                <span class="k">if</span> <span class="n">avg</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Taking row-wise mean&quot;</span> <span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">mymodel</span><span class="p">[</span><span class="n">non_numeric_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Taking row-wise median&quot;</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">mymodel</span><span class="p">[</span><span class="n">non_numeric_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
                <span class="c1"># Get levels on colToProject as a column</span>
                <span class="n">mymodel</span> <span class="o">=</span> <span class="n">mymodel</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="c1">#print(&quot;Nulls in summary model:&quot; ,  mymodel.isnull().sum().sum())</span>
    
                <span class="c1"># Check if mymodel holds a column with constant values.</span>
                <span class="c1">#   Remove all constant columns from mymodel</span>
                <span class="n">mymodel</span> <span class="o">=</span> <span class="n">mymodel</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">mymodel</span> <span class="o">!=</span> <span class="n">mymodel</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">()]</span>
                <span class="c1"># Check if mymodel has just two columns</span>
                <span class="c1">#   (Maybe column &#39;colToProject&#39; is a constant)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mymodel</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="c1"># If yes, merge with main dataframe</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># MAke mymodel&#39;s dtype of colToProject, same as that of df</span>
                    <span class="n">mymodel</span><span class="p">[</span><span class="n">colToProject</span><span class="p">]</span> <span class="o">=</span> <span class="n">mymodel</span><span class="p">[</span><span class="n">colToProject</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">colToProject</span><span class="p">])</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">mymodel</span><span class="p">,</span>  <span class="n">how</span><span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="n">colToProject</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="n">colToProject</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total memory used by X: &quot;</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="mi">1000000</span><span class="p">,</span> <span class="s2">&quot;mb&quot;</span> <span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">f</span> <span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nulls in </span><span class="si">{}</span><span class="s2">  are : </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">colToProject</span><span class="o">+</span><span class="s2">&quot;_ck_&quot;</span> <span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">colToProject</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span><span class="n">file</span> <span class="o">=</span> <span class="n">f</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transformation completed&quot;</span> <span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">f</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;====</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model mean values are constant. No transformation.&quot;</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">f</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;====</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">f</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">df</span>    </div>



    
<div class="viewcode-block" id="CatEncodersFamily._readAllStoredModels"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._readAllStoredModels">[docs]</a>    <span class="k">def</span> <span class="nf">_readAllStoredModels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: _loadStoredModels()</span>
<span class="sd">        Calls: None</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A list each element of which is a pandas DataFrame</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelList_</span><span class="p">:</span>
                <span class="n">model_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">orient</span> <span class="o">=</span> <span class="s1">&#39;tight&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># https://stackoverflow.com/a/40216619/3282777</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modelsPath</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;**/*.pkl&#39;</span><span class="p">)</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_file</span><span class="p">()]</span>
            
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="n">model_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_dfs</span></div>
 
    
    
    <span class="c1"># Reduce memory usage</span>
<div class="viewcode-block" id="CatEncodersFamily._reduceMemUsage"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._reduceMemUsage">[docs]</a>    <span class="k">def</span> <span class="nf">_reduceMemUsage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span> <span class="n">fromIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: transform()</span>
<span class="sd">        Calls: None  </span>
<span class="sd">        </span>
<span class="sd">        Desc</span>
<span class="sd">        ----</span>
<span class="sd">        The method changes data types from float64 to float32</span>
<span class="sd">        of all features of DataFrame, data, from </span>
<span class="sd">        column index: &#39;fromIndex&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: pandas dataframe</span>
<span class="sd">        fromIndex: int; Transform to float32 from column index fromIndex</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Returns complete pandas dataframe with datatypes changed</span>
<span class="sd">               </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current mem usage is: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="mi">1000000</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>  <span class="c1"># 9404.2MB/11163MB</span>
        <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">fromIndex</span><span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">fromIndex</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mem usage after dtype transformation is: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="mi">1000000</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>  <span class="c1"># 4734.6MB</span>
        <span class="k">return</span> <span class="n">data</span>    </div>
    
    
<div class="viewcode-block" id="CatEncodersFamily._getSample"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._getSample">[docs]</a>    <span class="k">def</span> <span class="nf">_getSample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: fit()</span>
<span class="sd">        Calls: None</span>
<span class="sd">        </span>
<span class="sd">        Desc</span>
<span class="sd">        -----</span>
<span class="sd">        Return stratified samples of size sampsize</span>
<span class="sd">        df, pandas dataframe.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pandas DataFrame</span>
<span class="sd">        y: pandas Series; Target</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A stratified sample of the dataframe</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span><span class="n">X_test</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> 
                                        <span class="n">test_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampsize</span><span class="p">,</span>
                                        <span class="n">stratify</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span>
                                        <span class="n">random_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sample size is: &quot;</span><span class="p">,</span> <span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">X_test</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_levelsTransformer</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">X_test</span></div>
    
        
        
        
<div class="viewcode-block" id="CatEncodersFamily._saveGraphToDisk"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._saveGraphToDisk">[docs]</a>    <span class="k">def</span> <span class="nf">_saveGraphToDisk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">G</span><span class="p">,</span> <span class="n">colToProject</span><span class="p">,</span> <span class="n">intermediaryCol</span><span class="p">,</span> <span class="n">modelsPath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bipartite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: _learn()</span>
<span class="sd">        Calls: None</span>
<span class="sd">        </span>
<span class="sd">        Desc</span>
<span class="sd">        -----</span>
<span class="sd">        Saves unipartite and bipartite graphs to disk in gml format</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        G : Graph object</span>
<span class="sd">        colToProject : string. cat column being projected</span>
<span class="sd">        intermediaryCol : string. cat column with which </span>
<span class="sd">                          bipartite graph is constructed.</span>
<span class="sd">        modelsPath : string. If None, then</span>
<span class="sd">                     default is self.modelsPath</span>
<span class="sd">        bipartite: boolean; Is the graph object G bipartite </span>
<span class="sd">                    or unipartite        </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">modelsPath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">modelsPath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelsPath</span>
            
        <span class="k">if</span> <span class="n">bipartite</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">colToProject</span> <span class="o">+</span> <span class="s2">&quot;_bigraph_&quot;</span> <span class="o">+</span> <span class="n">intermediaryCol</span><span class="o">+</span><span class="s2">&quot;.gml&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">colToProject</span> <span class="o">+</span> <span class="s2">&quot;_projected_&quot;</span> <span class="o">+</span> <span class="n">intermediaryCol</span><span class="o">+</span><span class="s2">&quot;.gml&quot;</span>
            
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">modelsPath</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span>  <span class="n">filename</span>
        <span class="c1">#nx.write_edgelist(G, path = q)</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">write_gml</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">q</span><span class="p">)</span>
        <span class="k">return</span></div>

        
    
    
    
<div class="viewcode-block" id="CatEncodersFamily._getRelCols"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._getRelCols">[docs]</a>    <span class="k">def</span> <span class="nf">_getRelCols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calls: None</span>
<span class="sd">            Calledby: _getCatVectors()</span>
<span class="sd">            </span>
<span class="sd">            Desc</span>
<span class="sd">            ----</span>
<span class="sd">            </span>
<span class="sd">                Gets related numeric columns. We started with a dataframe </span>
<span class="sd">                with a number of categorical features. These categorical </span>
<span class="sd">                features were transformed into dense vectors through our model </span>
<span class="sd">                formation process. We now intend to extract subset of dense vectors </span>
<span class="sd">                for each one of these cat features in a dictionary format. But </span>
<span class="sd">                before that we have to answer the question: for a specifc </span>
<span class="sd">                cat column, which of the columns among the transformed data </span>
<span class="sd">                constitute the dense veactors representing it.</span>
<span class="sd">                </span>
<span class="sd">                This method returns lists of cols that constitute dense vectors</span>
<span class="sd">                for each one of cat cols, such as: app, ip etc For example, </span>
<span class="sd">                cols related to feature app could be:</span>
<span class="sd">                </span>
<span class="sd">                [&#39;deg_app_ck_channel&#39;,&#39;deg_app_ck_device&#39;,&#39;deg_app_ck_ip&#39;, &#39;deg_app_ck_os&#39;...]   </span>
<span class="sd">                </span>
<span class="sd">                but not:</span>
<span class="sd">                </span>
<span class="sd">                [pr_app_p_os_ck_ip, deg_app_p_channel_ck_os.. ], </span>
<span class="sd">                </span>
<span class="sd">                as here we have concatenated cols (app,os) and (app,channel).</span>
<span class="sd">            </span>
<span class="sd">            Parameters:</span>
<span class="sd">            ----------</span>
<span class="sd">            </span>
<span class="sd">            cols: list; List of all the columns in the model: orig_cat + engineered</span>
<span class="sd">                  Typically: list(train_trans.columns)</span>
<span class="sd">                </span>
<span class="sd">            Returns</span>
<span class="sd">            --------</span>
<span class="sd">            </span>
<span class="sd">            List of columns that constitute dense vectors for each one of</span>
<span class="sd">            the cat cols such as: app, ip,channel, etc.</span>
<span class="sd">            </span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Separate out related columns</span>
            <span class="n">deck</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># say for [&#39;app&#39;, &#39;ip&#39;]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_cols</span><span class="p">)):</span>
                <span class="c1"># For app, include in t if i is pr_app_p_os_ck_ip OR deg_app_ck_device</span>
                <span class="n">t</span> <span class="o">=</span> <span class="p">[</span> <span class="n">i</span>       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cols</span>         <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span>  <span class="s1">&#39;_ck_&#39;</span> <span class="ow">in</span> <span class="n">i</span>    <span class="p">]</span>
                <span class="c1"># Split on _ck_</span>
                <span class="n">h</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_ck_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s1">&#39;_p_&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">):</span>
                        <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">deck</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_cols</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">h</span> 
            <span class="k">return</span> <span class="n">deck</span></div>
    



<div class="viewcode-block" id="CatEncodersFamily._getCatVectors"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._getCatVectors">[docs]</a>    <span class="k">def</span> <span class="nf">_getCatVectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>   <span class="n">X</span><span class="p">,</span> <span class="n">take_mean</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls: _getRelCols()</span>
<span class="sd">        Calledby: vectorsToTSV()</span>
<span class="sd">        </span>
<span class="sd">        Desc</span>
<span class="sd">        ----</span>
<span class="sd">            We now extract dense vectors cat-col by cat col, for every level in</span>
<span class="sd">            the column.</span>
<span class="sd">            Given a cat col, this method outputs for every level, corresponding</span>
<span class="sd">            vector values. The output is in a DataFrame format where one of the </span>
<span class="sd">            columns is cat col with its various levels and the other columns</span>
<span class="sd">            in the same row contain vector. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        </span>
<span class="sd">        X : pandas DataFrame. Transformed DataFrame. Transformed dataframe </span>
<span class="sd">            may also have, optionaly, original cat cols.</span>
<span class="sd">        take_mean: boolean. As a level value may be occurring many</span>
<span class="sd">                   times under any cat col(say, &#39;app&#39;), to create a final</span>
<span class="sd">                   transformtion vector should a mean of all vectors  </span>
<span class="sd">                   for each levelbe taken or not. Default is False.</span>
<span class="sd">                   </span>
<span class="sd">                   Example:</span>
<span class="sd">                   This is the the transformed dataset but also having</span>
<span class="sd">                   original cat cols along with transformed numeric cols.</span>
<span class="sd">                   Columns have been rearranged so that numeric cols </span>
<span class="sd">                   that correspond to a cat-col, say, app, are next to it.</span>
<span class="sd">                                          </span>
<span class="sd">                 index     app  deg_app_ck..   pr_app_ck_...   eig_app_ck... </span>
<span class="sd">                    0      213   0.10           0.20             0.11</span>
<span class="sd">                    1      214   0.45           0.18             0.22</span>
<span class="sd">                    ..     ...   ...            ...               ...</span>
<span class="sd">                    ..     ...   ...            ...               ... </span>
<span class="sd">                   1456    213   0.101          0.20             0.10</span>
<span class="sd">                    ..     ...   ...            ...               ... </span>
<span class="sd">                      </span>
<span class="sd">                  For level 213 of &#39;app&#39; col, we have two vectors: [0.10,0.20,0.11]</span>
<span class="sd">                  and [0.101,0.20,0.10] at different index positions. </span>
<span class="sd">                  We call them dense vectors. When normalized (along rows) </span>
<span class="sd">                  using l2 norm, we call them unitvectors. If take_mean is True, </span>
<span class="sd">                  a final vector for each level of &#39;app&#39; (say, 213) would be </span>
<span class="sd">                  calculated by taking mean of these vectors. This fnal vector </span>
<span class="sd">                  cane be used in Embedding Projector for plotting and displaying </span>
<span class="sd">                  relationship among levels of a catcol                  </span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            A dictionary with keys as column names in cat_cols. For every key,</span>
<span class="sd">            in the dict (say, &#39;app&#39;)&#39;, value is a dataframe. The dataframe&#39;s</span>
<span class="sd">            first column is a cat col (same as the dict key, say, &#39;app&#39;).</span>
<span class="sd">            Other columns map each level in this column (&#39;app&#39;) to difft </span>
<span class="sd">            derived centrality measures (that, together, we call as unitvectors).</span>
<span class="sd">            It is possible that same level may have different vectors at</span>
<span class="sd">            different row positions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Save target in a sep var</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">)</span>
        <span class="c1"># Remaining cols of X</span>
        <span class="n">datacols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        
        <span class="c1"># Extract a dict: list_rel_cols.</span>
        <span class="c1"># Its keys are cat col names.</span>
        <span class="c1"># For every key, say &#39;app&#39;,</span>
        <span class="c1"># value is a list (structure) of relevant</span>
        <span class="c1"># col-names</span>
        <span class="n">list_rel_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getRelCols</span><span class="p">(</span><span class="n">datacols</span><span class="p">)</span>
        
        <span class="c1"># We now create another dict, ess where</span>
        <span class="c1"># keys remain as cat cols (&#39;app&#39;) but</span>
        <span class="c1"># each value, instead of being a list struct,</span>
        <span class="c1"># is a dataframe. </span>
        <span class="c1"># That is ess[&#39;app&#39;] would be a DataFrame</span>
        <span class="n">ess</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">list_rel_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">ess</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">list_rel_cols</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
        
        <span class="c1"># Concatenate to each dataframe,</span>
        <span class="c1">#  the &#39;key&#39; columns also:</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ess</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span> <span class="n">ess</span><span class="p">[</span><span class="n">key</span><span class="p">]],</span>  <span class="n">axis</span> <span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># A level-value  (say, 235) will occur in a columns (&#39;app&#39;) at various</span>
            <span class="c1"># row-positions. There may be some diffrence between vectors of same </span>
            <span class="c1"># level; so take an average level-wise. Resulting grouped dataframe </span>
            <span class="c1"># has cat col as index, but sorted.</span>
            <span class="c1">#-----</span>
            <span class="c1"># Expt:29th June, 2023</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
            <span class="c1">#-----</span>
            <span class="n">yu</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="c1"># First column is key. Can be integer or category</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="n">yu</span><span class="p">,</span> <span class="n">sort</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="c1">#r = r.groupby(by = [key], sort = True).mean()</span>
            <span class="c1"># Get also index (&#39;app&#39;) as one of the columns</span>
            <span class="n">r</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span> <span class="p">:</span> <span class="n">key</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">take_mean</span><span class="p">:</span>
                <span class="c1"># Our vector dataframe is now ready</span>
                <span class="n">vec</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vec</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
                <span class="c1"># Add target col also</span>
                <span class="n">vec</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
        <span class="k">return</span> <span class="n">vec</span></div>
    
        
    
<div class="viewcode-block" id="CatEncodersFamily.vectorsToTSV"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily.vectorsToTSV">[docs]</a>    <span class="k">def</span> <span class="nf">vectorsToTSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span> <span class="n">take_mean</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">saveVectorsToDisk</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">filepath</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">impute</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fnamesuffix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls: _getCatVectors()</span>
<span class="sd">        Called by: main() when needed</span>
<span class="sd">        </span>
<span class="sd">        Desc</span>
<span class="sd">        ----</span>
<span class="sd">        This method transforms the vector dataframe of _getCatVectors()</span>
<span class="sd">        to two tsv files (per cat column) for uploading in tensorflow&#39;s</span>
<span class="sd">        &#39;Embedding Projector&#39;. One tsv file (say, app.tsv) has vectors :</span>
<span class="sd">        Example of file with 3-unitvectors with dimension 4:</span>
<span class="sd">            </span>
<span class="sd">           0.1\t0.2\t0.5\t0.9</span>
<span class="sd">           0.2\t0.1\t5.0\t0.2</span>
<span class="sd">           0.4\t0.1\t7.0\t0.8 </span>
<span class="sd">        </span>
<span class="sd">        The other tsv file (say, &#39;app_meta,tsv&#39;) is a file having metadata,</span>
<span class="sd">        as:</span>

<span class="sd">            label\tcolor</span>
<span class="sd">              221\t0</span>
<span class="sd">              234\t1</span>
<span class="sd">              316\t0</span>
<span class="sd">              302\t0</span>

<span class="sd">        Labels are levels of cat col (say, &#39;app&#39;) and &#39;color&#39;</span>
<span class="sd">        has&#39;target&#39; values. No further processing is required for </span>
<span class="sd">        uploading to Embedding Projector. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas DataFrame. Transformed DataFrame with transformed cols </span>
<span class="sd">            and also original columns (same as in cat_cols). It </span>
<span class="sd">            should also contain target column with name as &#39;target&#39;.</span>
<span class="sd">            </span>
<span class="sd">        take_mean: boolean. For details, see help under _getCatVectors(). </span>
<span class="sd">                   If False, then the meta tsv file also has a second </span>
<span class="sd">                   column, &#39;color&#39;, having &#39;target&#39; column values for </span>
<span class="sd">                   coloring points in the Embeddinng Projector.</span>
<span class="sd">                   Default is False. </span>
<span class="sd">                   </span>
<span class="sd">        saveVectorsToDisk: boolean; Save tsv files to disk?  Default is True.          </span>

<span class="sd">        filepath : string; Folder where two tsv files corresponding to each </span>
<span class="sd">                   cat column will be saved. If None, it is pathToStoreProgress.</span>
<span class="sd">                   Default is None.</span>
<span class="sd">        </span>
<span class="sd">        impute: boolean; Imputes X with median strategy and outputs impute model</span>
<span class="sd">                for future use. If False, </span>
<span class="sd">        fnamesuffix: str; A suffix to be added to tsv filenames</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Outputs two objects: One, a dictionary with keys as cat cols and values as corresponding </span>
<span class="sd">        DataFrames and the other an Impute model (or None).</span>
<span class="sd">        Example: </span>
<span class="sd">                Our input DataFrame has four rows:</span>
<span class="sd">                   &#39;app&#39;     &#39;ip&#39;     &#39;os&#39;</span>
<span class="sd">                    203       198      4</span>
<span class="sd">                    202       199      3</span>
<span class="sd">                    205       198      4</span>
<span class="sd">                    203       200     10</span>
<span class="sd">        </span>
<span class="sd">        vec_dict[&#39;app&#39;]</span>
<span class="sd">        </span>
<span class="sd">                 deg_    pr_   clu_</span>
<span class="sd">        row 1   0.05    0.8    0.34 </span>
<span class="sd">        row 2   0.003   0.78   0.45</span>
<span class="sd">        row 3   0.33    0.32   0.17</span>
<span class="sd">        row 4   0.051   0.79   0.34  (very similar to row 1)</span>
<span class="sd">        </span>
<span class="sd">        When take_mean = True then output dataframe has 3-rows</span>
<span class="sd">        and mean of row1 and row4 are taken to represent</span>
<span class="sd">        the corresponding level.</span>
<span class="sd">        </span>
<span class="sd">        In the meta data, &#39;label&#39; column will store row-wise &#39;app&#39;</span>
<span class="sd">        values, ie:</span>
<span class="sd">            203</span>
<span class="sd">            202</span>
<span class="sd">            205</span>
<span class="sd">            203</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if X has a &#39;target&#39; column</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;target&#39;</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Passed DataFrame does not contain &#39;target&#39; column even if dummy!&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">impute</span><span class="p">:</span>
            <span class="n">si</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span><span class="p">)</span>
            <span class="c1"># Remember X also has target column</span>
            <span class="n">X</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="n">si</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="n">vec_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCatVectors</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">take_mean</span><span class="p">)</span>
        <span class="c1"># Possible that for some cat_cols, we do not have</span>
        <span class="c1">#  any vectors. So ignore them</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking if vectors exist for all cat cols...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;May take time...&quot;</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vec_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># Get no of columns of this DataFrame</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">vec_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Should have more than 2 cols besides&#39;target&#39; and i </span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># We do have vectors for this i</span>
                <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Vectors do not exist for this i</span>
                <span class="c1"># Note it</span>
                <span class="n">gap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checked for </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>   
            
        <span class="c1"># Inform if for some cat col there are no vectors    </span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gap</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For these columns we do not have vectors: &quot;</span><span class="p">,</span> <span class="n">gap</span><span class="p">)</span>
            
        <span class="n">vec_dict</span> <span class="o">=</span> <span class="n">r</span>  <span class="c1"># Our revised dict</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="c1"># If tsv files are not to be saved to disk:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">saveVectorsToDisk</span><span class="p">:</span>
            <span class="c1"># pop out target col from all data frames</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vec_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">vec_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">)</span>
                <span class="n">vec_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="c1"># Normalize row vector to unit vector using sklearn function</span>
                <span class="n">colnames</span> <span class="o">=</span> <span class="n">vec_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">vec_dict</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  
                <span class="c1"># &#39;d&#39; being np.array(), convert back to DataFrame</span>
                <span class="n">vec_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">columns</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">vec_dict</span><span class="p">,</span> <span class="n">si</span>
        
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pathToStoreProgress</span>
            <span class="c1"># If filepath folder does not exist, create one</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">(</span><span class="n">filepath</span><span class="p">)):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                

        <span class="c1"># DataFrame to hold meta data</span>
        <span class="n">vec_meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">,</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>
        
        <span class="c1"># For every cat col, i</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vec_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            
            <span class="c1"># Fill meta data values in DataFrame</span>
            <span class="n">vec_meta</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">take_mean</span><span class="p">:</span>
                <span class="c1"># Then, we do not have a target column</span>
                <span class="c1">#  in vec_dict[i]</span>
                <span class="n">vec_meta</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">vec_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">)</span> <span class="c1">#   0 </span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vec_meta</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">)</span>
            
            
            <span class="k">if</span> <span class="n">fnamesuffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">fnamesuffix</span> <span class="o">+</span> <span class="s2">&quot;_meta.tsv&quot;</span>  <span class="c1"># say, app_meta.tsv</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span>  <span class="s2">&quot;_meta.tsv&quot;</span>  <span class="c1"># say, app_meta.tsv</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="o">/</span> <span class="n">fname</span>    
            <span class="n">vec_meta</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">p</span> <span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Next our vector file:</span>
            <span class="k">if</span> <span class="n">fnamesuffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">fnamesuffix</span> <span class="o">+</span> <span class="s2">&quot;.tsv&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="s2">&quot;.tsv&quot;</span>
                
            <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="o">/</span> <span class="n">fname</span>    
            <span class="c1"># We need this for the next step</span>
            <span class="n">colnames</span> <span class="o">=</span> <span class="n">vec_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>
            <span class="c1"># Normalize row vector to unit vector using sklearn function</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">vec_dict</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  
            <span class="c1"># &#39;d&#39; being np.array(), convert back to DataFrame</span>
            <span class="n">vec_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">columns</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">)</span>
            <span class="c1"># Save our vector file as tab-separated without header and without</span>
            <span class="c1"># index</span>
            <span class="n">vec_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">p</span> <span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Not sure why the following &#39;sleep&#39; line was needed!</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        
        <span class="c1"># Task over. Print messages:   </span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=============================================================&quot;</span><span class="p">)</span>    
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saved files are named as &#39;&lt;catColname&gt;.tsv&#39; and &#39;&lt;catColname_meta&gt;.tsv&#39;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You will find them in folder: &#39;</span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=============================================================&quot;</span><span class="p">)</span>    
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load these file-pairs in tensorflow&#39;s &#39;Embedding Projector&#39;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;It helps in visualizing interrelationships among levels of a categorical feature&quot;</span><span class="p">)</span>
        
        <span class="c1"># Return the dict, and impute model used</span>
        <span class="k">return</span> <span class="n">vec_dict</span><span class="p">,</span> <span class="n">si</span></div>
        
    
        
        <span class="c1"># Networkx graph visualizaton:</span>
        <span class="c1"># https://stackoverflow.com/q/57696572/3282777   </span>
        <span class="c1"># https://stackoverflow.com/q/57603117/3282777 </span>
<div class="viewcode-block" id="CatEncodersFamily.plotNetworkGraph"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily.plotNetworkGraph">[docs]</a>    <span class="k">def</span> <span class="nf">plotNetworkGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">graphfilename</span><span class="p">,</span>
                         <span class="n">k</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>            <span class="c1"># Optimal distance between nodes in spring_layout. None implies k= 1</span>
                         <span class="n">withLabels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">fontSize</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>       <span class="c1"># If withLabels is True</span>
                         <span class="n">filepath</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> 
                         <span class="n">connected_nodes</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls: None</span>
<span class="sd">        Called by: main() when needed</span>
<span class="sd">        </span>
<span class="sd">        Desc</span>
<span class="sd">        ----</span>
<span class="sd">        </span>
<span class="sd">        Plot network graph generated by the class-instance (when self.saveGraph is True).</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graphfilename : string; graph filename saved earlier by class-instance</span>
<span class="sd">        k       : int; For spring layout, this is optimal distance between nodes. None</span>
<span class="sd">                  implies k=1.</span>
<span class="sd">        withLabels: boolean. Should node labels be displayed</span>
<span class="sd">        fontSize: int; Label font size when displayed</span>
<span class="sd">        filepath : string; Folder where file is placed. Default location is where </span>
<span class="sd">                   the class-instance saved the file. Optional.</span>
<span class="sd">        figsize : tuple. The default is (10,5).</span>
<span class="sd">        connected_nodes : boolean, optional, default is True.</span>
<span class="sd">                          Should all nodes be plotted or only</span>
<span class="sd">                          connected nodes be plotted</span>
<span class="sd">                          </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>
<span class="sd">    </span>
<span class="sd">        &quot;&quot;&quot;</span>
      
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;May take time if number of nodes are large&quot;</span><span class="p">)</span>
        
        <span class="c1"># Split filename into three parts:</span>
        <span class="c1"># Example:  &quot;mgrid_bigraph_rolecode.gml&quot;</span>
        <span class="c1">#           [&quot;mgrid&quot;,&quot;bigraph&quot;, &quot;rolecode.gml&quot;]</span>
        <span class="n">com</span> <span class="o">=</span> <span class="n">graphfilename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">colToProject</span> <span class="o">=</span> <span class="n">com</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xt</span> <span class="o">=</span> <span class="n">com</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">intermediaryCol</span> <span class="o">=</span> <span class="n">xt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Default location of graph file</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelsPath</span>
        
        <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="o">/</span> <span class="n">graphfilename</span>
        
        <span class="c1"># Read graph file:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">read_gml</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> 
        
        <span class="c1"># Extract connected nodes only</span>
        <span class="n">gcc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="c1"># subgraph of connected nodes:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">gcc</span><span class="p">)</span>
        
        <span class="n">color_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;r&#39;</span><span class="p">}</span>
        
        <span class="c1"># Set plot figure size</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">com</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bigraph&#39;</span><span class="p">:</span>      <span class="c1"># If it is a bigraph</span>
            <span class="c1"># Avoid plotting isolated nodes</span>
            <span class="k">if</span> <span class="n">connected_nodes</span><span class="p">:</span>
                <span class="c1"># Get color list as per node properties</span>
                <span class="c1">#color = bipartite.color(H)</span>
                <span class="n">color_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">color_dict</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">H</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="s1">&#39;bipartite&#39;</span><span class="p">)]</span>
                
                <span class="c1"># Plot the network now        </span>
                <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Bipartite graph of only connected nodes from &#39;</span> <span class="o">+</span> <span class="n">colToProject</span> <span class="o">+</span> <span class="s2">&quot; and from &quot;</span> <span class="o">+</span> <span class="n">intermediaryCol</span><span class="p">,</span>
                             <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                             <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span>
                             <span class="p">)</span>
                <span class="c1"># This is legend information</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Blue:&#39;</span> <span class="o">+</span> <span class="n">colToProject</span> <span class="o">+</span><span class="s2">&quot;,Red:&quot;</span> <span class="o">+</span> <span class="n">intermediaryCol</span> <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_size</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># title font size</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_weight</span><span class="p">(</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">spring_layout</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
                <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span> <span class="n">pos</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">with_labels</span> <span class="o">=</span>  <span class="n">withLabels</span><span class="p">,</span> <span class="n">font_size</span> <span class="o">=</span> <span class="n">fontSize</span><span class="p">,</span> <span class="n">node_color</span> <span class="o">=</span> <span class="n">color_list</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>    <span class="c1"># Else, plot all nodes   </span>
                <span class="c1"># Get color list as per node properties</span>
                <span class="c1">#color = bipartite.color(G)</span>
                <span class="n">color_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">color_dict</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="s1">&#39;bipartite&#39;</span><span class="p">)]</span>
    
                
                <span class="c1"># Plot the network now        </span>
                <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Bipartite graph of all nodes from &#39;</span> <span class="o">+</span> <span class="n">colToProject</span> <span class="o">+</span> <span class="s2">&quot; and from &quot;</span> <span class="o">+</span> <span class="n">intermediaryCol</span><span class="p">,</span>
                             <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                             <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span>
                             <span class="p">)</span>
                <span class="c1"># This is legend information</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Blue:&#39;</span> <span class="o">+</span> <span class="n">colToProject</span> <span class="o">+</span><span class="s2">&quot;,Red:&quot;</span> <span class="o">+</span> <span class="n">intermediaryCol</span> <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_size</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># title font size</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_weight</span><span class="p">(</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">spring_layout</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
                <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">with_labels</span> <span class="o">=</span>  <span class="n">withLabels</span><span class="p">,</span><span class="n">font_size</span> <span class="o">=</span> <span class="n">fontSize</span><span class="p">,</span> <span class="n">node_color</span> <span class="o">=</span> <span class="n">color_list</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>     <span class="c1"># It is a unipartite graph     </span>
            <span class="k">if</span> <span class="n">connected_nodes</span><span class="p">:</span>   <span class="c1"># But avoid plotting isolated nodes</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Unipartite graph&quot;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span> 
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Projected graph of &#39;</span> <span class="o">+</span> <span class="n">colToProject</span> <span class="o">+</span> <span class="s1">&#39; (only connected nodes) as seen through &#39;</span> <span class="o">+</span> <span class="n">intermediaryCol</span><span class="p">)</span> 
                <span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_size</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>   <span class="c1"># title font size</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_weight</span><span class="p">(</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">spring_layout</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
                <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">with_labels</span> <span class="o">=</span>  <span class="n">withLabels</span><span class="p">,</span><span class="n">font_size</span> <span class="o">=</span> <span class="n">fontSize</span><span class="p">,</span> <span class="n">node_color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span><span class="n">ax</span><span class="p">)</span>
               
            <span class="k">else</span><span class="p">:</span>    <span class="c1"># No, plot all nodes </span>
                <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Unipartite graph&quot;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span> 
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Projected graph of &#39;</span> <span class="o">+</span> <span class="n">colToProject</span> <span class="o">+</span> <span class="s1">&#39; (all nodes) as seen through &#39;</span> <span class="o">+</span> <span class="n">intermediaryCol</span><span class="p">)</span> 
                <span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_size</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># title font size</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_weight</span><span class="p">(</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">spring_layout</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
                <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">with_labels</span> <span class="o">=</span>  <span class="n">withLabels</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="n">fontSize</span><span class="p">,</span> <span class="n">node_color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">return</span></div>
    
 
    <span class="c1"># Save dictionary to file</span>
<div class="viewcode-block" id="CatEncodersFamily._save_dict_to_file"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._save_dict_to_file">[docs]</a>    <span class="k">def</span> <span class="nf">_save_dict_to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dic</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: levelsTransformer()</span>
<span class="sd">        Given a dictionary and &#39;filename&#39;,</span>
<span class="sd">        saves dict as a .pkl file at</span>
<span class="sd">        folder: pathToFile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapDictPath</span><span class="p">)</span> <span class="o">/</span> <span class="n">filename</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>
            
            
            
    <span class="c1"># Called by updateLevels(), levelsTransformer()</span>
    <span class="c1">#   and readAllMappingDict()</span>
<div class="viewcode-block" id="CatEncodersFamily._load_dict_from_file"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._load_dict_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">_load_dict_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: _updateLevels(), _levelsTransformer() </span>
<span class="sd">        Returns dictionary saved into a pickle file: &#39;filename&#39;</span>
<span class="sd">          &#39;filename&#39; is in folder &#39;pathToFile&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapDictPath</span><span class="p">)</span> <span class="o">/</span>  <span class="n">filename</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">loaded_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loaded_dict</span></div>
            
    
<div class="viewcode-block" id="CatEncodersFamily._levelsTransformer"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._levelsTransformer">[docs]</a>    <span class="k">def</span> <span class="nf">_levelsTransformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls: _load_dict_from_file(), _mergeRareLevels(), _save_dict_to_file()</span>
<span class="sd">        Called by: _getSample()</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        df: Dataframe under consideration</span>
<span class="sd">        feature: Column whose levels are to be reduced</span>
<span class="sd">        thresholdValue_count: If integer, keep only those levels whose value_count</span>
<span class="sd">                              exceeds this number. If float, keep only those levels</span>
<span class="sd">                              whose percentages are above this value.</span>
<span class="sd">        mapdictpath : Dictionary which stores mapping between existing levels</span>
<span class="sd">                      and new levels.</span>
<span class="sd">        action: The value determines how an integer thresholdValue_count will be </span>
<span class="sd">                interpreted: Either permit those levels whose value_counts() exceed</span>
<span class="sd">                this value (action = False) or set max number of unique levels</span>
<span class="sd">                to this value (action = True).</span>
<span class="sd">        Usage</span>
<span class="sd">        -----</span>
<span class="sd">        X =  utils.levelsTransformer(X, &#39;ip&#39;,mergethreshold, mapdictpath, action)</span>
<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        Returns DataFrame with reduced levels for &#39;feature&#39; column</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Does this file exist:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;mapLevelsDict&quot;</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mergelevelsincols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span><span class="s2">&quot;.pkl&quot;</span>
        <span class="n">mf</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapDictPath</span><span class="p">)</span> <span class="o">/</span> <span class="n">filename</span>
        <span class="c1"># If yes read mapping dictinary</span>
        <span class="k">if</span> <span class="n">mf</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="c1">#mapdict = load_dict_from_file(&quot;mapLevelsDict_device.pkl&quot;, mapdictpath)</span>
            <span class="n">mapdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_dict_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Existing saved dictionary loaded&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No saved dictionary exists as yet.&quot;</span><span class="p">)</span>
            <span class="n">mapdict</span> <span class="o">=</span> <span class="kc">None</span>
    
        <span class="n">X</span><span class="p">,</span><span class="n">mapdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mergeRareLevels</span><span class="p">(</span> <span class="n">X</span><span class="p">,</span><span class="n">mapdict</span><span class="p">,</span>  <span class="n">action</span><span class="p">)</span>
    
        <span class="c1">#if isinstance(thresholdValue_count, int):</span>
            <span class="c1"># Update mapping dictionary</span>
        <span class="c1">#    df, mapdict = mergeRareLevels(df,feature, thresholdValue_count, mapdict)</span>
        <span class="c1">#else:</span>
            <span class="c1"># thresholdValue_count is float</span>
        <span class="c1">#    df, mapdict = mergeLevels(df,feature, mapdict, thresholdValue_count)</span>
    
        <span class="c1"># Save updated dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_dict_to_file</span><span class="p">(</span><span class="n">mapdict</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span></div>
        
        

    <span class="c1"># Amended on 6th March, 2023</span>
<div class="viewcode-block" id="CatEncodersFamily._mergeRareLevels"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._mergeRareLevels">[docs]</a>    <span class="k">def</span> <span class="nf">_mergeRareLevels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">mapdict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="n">action</span><span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by: self._levelsTransformer()</span>
<span class="sd">        </span>
<span class="sd">        Desc</span>
<span class="sd">        ----</span>
<span class="sd">        A mapdict is a dictionary where &#39;key&#39; is old_level</span>
<span class="sd">        name and value is the new level name (&#39;99999&#39;).</span>
<span class="sd">        For a level which has high occurrenceThreshold,</span>
<span class="sd">        both &#39;key&#39; and &#39;value&#39; would be same. If no earlier</span>
<span class="sd">        mapdict exist:</span>
<span class="sd">            In df[colName] merge all those level-names</span>
<span class="sd">            by &#39;replaceby&#39; whose total count is less</span>
<span class="sd">            than or equal to occurrenceThreshold. A</span>
<span class="sd">            new model created and returned.</span>
<span class="sd">        If a mapdict already exists:</span>
<span class="sd">            the mapdict is updated only to the extent</span>
<span class="sd">            of new key. if an existing key in the existing</span>
<span class="sd">            mapdict now is to get a new value, that updation</span>
<span class="sd">            is NOT carried out.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        df: DataFrame</span>
<span class="sd">        colName: Columns whose levels are to be examined for rareness</span>
<span class="sd">        occurrenceThreshold: This decides if a level is rare and be merged</span>
<span class="sd">        mapdict: Mapping of actual levels with merged levels</span>
<span class="sd">        action: The value determines how an integer occurrenceThreshold will be </span>
<span class="sd">                interpreted: Either permit those levels whose value_counts() exceed</span>
<span class="sd">                this value (action = False) or set max number of unique levels</span>
<span class="sd">                to this value (action = True).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mapdict and dataframe modified as per the mapdict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># See code examples at the end of this module</span>
        <span class="c1"># Get present value_counts of each level</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mergelevelsincols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mergethreshold</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">action</span><span class="p">:</span>
                <span class="c1"># Is any value_count greater than occurrenceThreshold</span>
                <span class="n">cond</span> <span class="o">=</span> <span class="n">series</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mergethreshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Limit number of unique levels to occurrenceThreshold</span>
                <span class="n">series</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">mergethreshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">series</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mergethreshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]:]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">cond</span> <span class="o">=</span> <span class="n">series</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># occurrenceThreshold is a percentage value</span>
            <span class="c1">#  ie occurrenceThreshold%</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="p">((</span><span class="n">series</span><span class="o">/</span><span class="n">series</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mergethreshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Now, get revised replacement values.</span>
        <span class="n">remapped_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">series</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">replaceby</span><span class="p">)</span>
        <span class="c1"># Create a dictionary of what is to be replaced with what</span>
        <span class="c1"># This will also serve as model for future data</span>
        <span class="n">currentmodel</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">remapped_levels</span><span class="p">)}</span>
    
        <span class="k">if</span> <span class="n">mapdict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Revise the model as per current. Include new keys only</span>
            <span class="c1">#  Let earlier key-value pairs remain as they are:</span>
                
            <span class="c1"># First get those model.keys() whose value is not replaceby</span>
            <span class="n">p_keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mapdict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">mapdict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replaceby</span><span class="p">:</span>
                    <span class="c1"># The value of this key will not be replaced by replaceby</span>
                    <span class="n">p_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                   
            <span class="c1">#newkeys = set(currentmodel.keys()) - set(model.keys())</span>
            <span class="c1"># p_keys were above threshold level in earlier cases</span>
            <span class="c1">#  so no need to modify them</span>
            <span class="n">newkeys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">currentmodel</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">p_keys</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">newkeys</span><span class="p">:</span>
                <span class="n">mapdict</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span> <span class="o">=</span> <span class="n">currentmodel</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span>
            <span class="n">modelToApply</span> <span class="o">=</span> <span class="n">mapdict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modelToApply</span> <span class="o">=</span> <span class="n">currentmodel</span>
    
        <span class="c1"># The following code is very slow</span>
        <span class="c1">#df[colName] = df[colName].replace(model)</span>
        <span class="c1"># This one using map() is fast</span>
        <span class="c1"># https://stackoverflow.com/a/41987136</span>
        <span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mergelevelsincols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mergelevelsincols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">modelToApply</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
        <span class="k">return</span>  <span class="n">X</span><span class="p">,</span> <span class="n">modelToApply</span></div>
          
    

<div class="viewcode-block" id="CatEncodersFamily._updateLevels"><a class="viewcode-back" href="../modules.html#catencfamily.CatEncodersFamily._updateLevels">[docs]</a>    <span class="k">def</span> <span class="nf">_updateLevels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Desc</span>
<span class="sd">        ======</span>
<span class="sd">            Given a set of saved dictionaries, that map Existing</span>
<span class="sd">            column levels (keys in the dict) to new levels (values</span>
<span class="sd">            in the dict), this function updates DataFrame column</span>
<span class="sd">            values (levels) as per the mapping specified in the</span>
<span class="sd">            correspondng keys of dict.</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">        ===========</span>
<span class="sd">            df: Pandas dataframe </span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        ========</span>
<span class="sd">            Dataframe after column levels have been replaced by</span>
<span class="sd">            a given mapping as specified in a file in  mapDictPath   </span>
<span class="sd">    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Read all files storing mapping dictionaries</span>
        <span class="c1">#files = os.listdir(mapdictpath)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapDictPath</span><span class="p">)</span><span class="o">.</span><span class="n">iterdir</span><span class="p">())</span>
        
        <span class="c1"># If the folder does not hold any map file</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">df</span>
        
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="c1"># split filename only at the first &quot;_&quot;</span>
            <span class="c1"># We get the column name wherein levels are</span>
            <span class="c1">#  to be mapped/updated</span>
            <span class="c1">#  Example&quot; mapLevelsDict_channel_p_ip.pkl</span>
            <span class="n">colName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># Column &#39;channel_p_ip.pkl&#39;</span>
            <span class="n">colName</span> <span class="o">=</span> <span class="n">colName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># Jettison &#39;&#39;.pkl&#39;; get: &#39;channel_p_ip&#39;</span>
    
            <span class="k">if</span> <span class="n">colName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_cols</span><span class="p">:</span>
                <span class="c1"># Get its datatype</span>
                <span class="n">datatype</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">colName</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
                <span class="c1"># Read the Dictionary into &#39;mapdict&#39;</span>
                <span class="n">mapdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_dict_from_file</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
                <span class="c1"># Get all keys</span>
                <span class="n">keys_df</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">colName</span><span class="p">])</span>
                <span class="c1"># GEt all keys in mapdict</span>
                <span class="n">keys_mapdict</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="c1"># mapdict does not have mapping for the following keys:</span>
                <span class="n">not_present_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">keys_df</span><span class="p">)</span> <span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">keys_mapdict</span><span class="p">)</span>
                <span class="c1"># So create default mapping</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">replaceby</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">not_present_keys</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">not_present_keys</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
                <span class="c1"># Update mapdict with these added mappings</span>
                <span class="n">mapdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="c1"># Perform transformation as per updated dictionary</span>
                <span class="n">df</span><span class="p">[</span><span class="n">colName</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">colName</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mapdict</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
                <span class="c1"># Reset datatype</span>
                <span class="n">df</span><span class="p">[</span><span class="n">colName</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">colName</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div></div>
    
    
    
 
    
 
    
 
    
 
    
 <span class="c1">###############333##################               </span>
       
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Prof. Ashok Harnal.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>